<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊÄ•Ë®∫ÊéíÁè≠Á≥ªÁµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header {
            background: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px 8px 0 0;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        input, select, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            background: #007bff;
            color: white;
            border: 1px solid #007bff;
            cursor: pointer;
            font-weight: 500;
        }

        button:hover {
            background: #0056b3;
        }

        .staff-section {
            background: white;
            padding: 0;
            border-bottom: 1px solid #dee2e6;
        }

        .section-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .section-header:hover {
            background: #e9ecef;
        }

        .section-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collapse-icon {
            font-size: 14px;
            transition: transform 0.2s;
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 20px;
            display: block;
        }

        .section-content.collapsed {
            display: none;
        }

        .requirements-section {
            background: white;
            padding: 0;
            border-bottom: 1px solid #dee2e6;
        }

        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .staff-header {
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .staff-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .staff-card h4 {
            color: #495057;
            margin-bottom: 10px;
        }

        .leave-dates {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .leave-tag {
            background: #fff3cd;
            color: #856404;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            border: 1px solid #ffeaa7;
        }

        .schedule-container {
            padding: 20px;
        }

        .schedule-grid {
            display: grid;
            gap: 1px;
            background: #ddd;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 15px;
        }

        .grid-header, .grid-cell {
            background: white;
            padding: 6px 4px;
            text-align: center;
            font-size: 12px;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .grid-header {
            background: #495057;
            color: white;
            font-weight: 600;
        }

        .day-header {
            background: #6c757d !important;
            color: white;
            font-weight: 600;
            min-height: 50px !important;
        }

        .day-header.weekend {
            background: #dc3545 !important;
            color: white;
        }

        .day-number {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .day-name {
            font-size: 10px;
            opacity: 0.9;
        }

        .staff-name {
            background: #495057 !important;
            color: white;
            font-weight: 600;
            justify-content: flex-start;
            padding-left: 8px;
        }

        .shift-day {
            background: #cce7ff;
            color: #004085;
            font-weight: 600;
        }

        .shift-night {
            background: #d4edda;
            color: #155724;
            font-weight: 600;
        }

        .shift-both {
            background: #ffeaa7;
            color: #856404;
            font-weight: 600;
        }

        .leave-day {
            background: #fff3cd;
            color: #856404;
        }

        .conflict {
            background: #f8d7da !important;
            color: #721c24;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .summary-card {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            text-align: center;
        }

        .summary-value {
            font-size: 20px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 12px;
            color: #6c757d;
        }

        .leave-analysis {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .leave-analysis h4 {
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .high-leave-days {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .leave-day-tag {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .leave-day-tag.medium {
            background: #fd7e14;
        }

        .leave-day-tag.low {
            background: #28a745;
        }

        .stat-card {
            background: #007bff;
            color: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .requirements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .day-requirement {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            text-align: center;
        }

        .day-requirement.weekend {
            background: #fff5f5;
            border-color: #fed7d7;
        }

        .conflict-list {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
        }

        .conflict-item {
            color: #721c24;
            margin-bottom: 5px;
        }

        h3 {
            color: #495057;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .schedule-grid {
                font-size: 10px;
                grid-template-columns: 60px repeat(31, 1fr);
            }
            
            .grid-cell {
                min-height: 30px;
                padding: 4px 2px;
            }
            
            .day-header {
                min-height: 40px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• ÊÄ•Ë®∫ÊéíÁè≠Á≥ªÁµ±</h1>
            <p>Êô∫ËÉΩÊéíÁè≠ ‚Ä¢ Á¥ÑÊùüÁÆ°ÁêÜ ‚Ä¢ ÂÖ¨Âπ≥ÂàÜÈÖç</p>
            <p style="font-size: 14px; margin-top: 8px; opacity: 0.9;">
                Ë¶èÂâáÔºöÈÄ£Á∫åÂ∑•‰ΩúÂ§©Êï∏=Âπ≥ÂùáÂ§úÁè≠Êï∏ ‚Ä¢ Â§úÁè≠Âæå‰∏çËÉΩÊé•ÁôΩÁè≠ ‚Ä¢ È†êÂÅáÂâç‰∏ÄÂ§©‰∏çÊéíÂ§úÁè≠ ‚Ä¢ ÊØèÊúàÊúÄÂæå‰∏ÄÂ§©Â§úÁè≠0‰∫∫ ‚Ä¢ ÁõÆÊ®ôÂ§úÁè≠Êï∏Âπ≥ÂùáÂàÜÈÖç
            </p>
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label>Âπ¥Êúà</label>
                    <input type="month" id="monthSelect" value="2025-08">
                </div>
                <div class="control-group">
                    <label>Âì°Â∑•‰∫∫Êï∏</label>
                    <input type="number" id="staffCount" min="8" max="12" value="10">
                </div>
                <div class="control-group">
                    <label>ÊéíÁè≠Ê®°Âºè</label>
                    <select id="scheduleMode">
                        <option value="continuous">ÈÄ£Á∫åÊéíÁè≠Ê®°Âºè</option>
                        <option value="balanced">Âπ≥Ë°°ÂàÜÊï£Ê®°Âºè</option>
                    </select>
                </div>
                <button onclick="generateStaffList()">Êõ¥Êñ∞Âì°Â∑•Ê∏ÖÂñÆ</button>
                <button onclick="generateSchedule()">üéØ Ëá™ÂãïÊéíÁè≠</button>
                <button onclick="exportSchedule()">üìã ÂåØÂá∫ÊéíÁè≠Ë°®</button>
            </div>
        </div>

        <div class="staff-section">
            <div class="section-header" onclick="window.toggleSection('staff')">
                <h3>üë• Âì°Â∑•ÁÆ°ÁêÜ</h3>
                <span class="collapse-icon" id="staff-icon">‚ñº</span>
            </div>
            <div class="section-content" id="staff-content">
                <div id="staffGrid" class="staff-grid"></div>
            </div>
        </div>

        <div class="requirements-section">
            <div class="section-header" onclick="window.toggleSection('requirements')">
                <h3>üìÖ ÊØèÊó•‰∫∫ÂäõÈúÄÊ±ÇË®≠ÂÆö</h3>
                <span class="collapse-icon" id="requirements-icon">‚ñº</span>
            </div>
            <div class="section-content" id="requirements-content">
                <div class="stats-summary" id="requirementsSummary"></div>
                <div id="leaveAnalysis"></div>
                <div id="requirementsGrid" class="requirements-grid"></div>
            </div>
        </div>

        <div class="schedule-container">
            <h3>üìã ÊéíÁè≠Ë°®</h3>
            <div id="conflictList"></div>
            <div id="scheduleGrid" class="schedule-grid"></div>
            
            <div class="stats" id="stats"></div>
        </div>
    </div>

    <script>
        class EmergencyScheduler {
            constructor() {
                this.staff = [];
                this.schedule = {};
                this.requirements = {};
                this.currentMonth = '';
                this.daysInMonth = 0;
                this.conflicts = [];
            }

            init() {
                this.updateMonth();
                this.generateStaffList();
                this.generateRequirements();
                this.initializeEmptySchedule();
                this.renderAll();
            }

            updateMonth() {
                const monthInput = document.getElementById('monthSelect');
                this.currentMonth = monthInput.value;
                const date = new Date(this.currentMonth + '-01');
                this.daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            }

            // Áç≤ÂèñÊòüÊúüÂêçÁ®±
            getDayOfWeek(day) {
                const date = new Date(this.currentMonth + '-' + day.toString().padStart(2, '0'));
                const dayNames = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
                return dayNames[date.getDay()];
            }

            // Âà§Êñ∑ÊòØÂê¶ÁÇ∫ÈÄ±Êú´
            isWeekend(day) {
                const date = new Date(this.currentMonth + '-' + day.toString().padStart(2, '0'));
                const dayOfWeek = date.getDay();
                return dayOfWeek === 0 || dayOfWeek === 6; // 0=ÈÄ±Êó•, 6=ÈÄ±ÂÖ≠
            }

            generateStaffList() {
                this.updateMonth();
                const count = parseInt(document.getElementById('staffCount').value);
                
                // ‰øùÁïôÁèæÊúâÂì°Â∑•ÁöÑÂßìÂêçÂíåË´ãÂÅáË≥áÊñô
                const existingStaff = {};
                this.staff.forEach(s => {
                    existingStaff[s.id] = {
                        name: s.name,
                        leaveRequests: s.leaveRequests || []
                    };
                });

                this.staff = [];
                const defaultNames = ['ÁéãÈÜ´Â∏´', 'ÊùéÈÜ´Â∏´', 'ÂºµÈÜ´Â∏´', 'Èô≥ÈÜ´Â∏´', 'ÊûóÈÜ´Â∏´', 'ÈªÉÈÜ´Â∏´', 
                              'Âê≥ÈÜ´Â∏´', 'ÂäâÈÜ´Â∏´', 'Ëî°ÈÜ´Â∏´', 'Ë®±ÈÜ´Â∏´', 'ÈÑ≠ÈÜ´Â∏´', 'Ë¨ùÈÜ´Â∏´'];
                
                for (let i = 0; i < count; i++) {
                    // Â¶ÇÊûú‰πãÂâçÂ∑≤ÊúâÈÄôÂÄãIDÁöÑÂì°Â∑•Ôºå‰øùÁïôÂÖ∂Ë≥áÊñô
                    if (existingStaff[i]) {
                        this.staff.push({
                            id: i,
                            name: existingStaff[i].name,
                            leaveRequests: existingStaff[i].leaveRequests
                        });
                    } else {
                        // Êñ∞Â¢ûÂì°Â∑•‰ΩøÁî®È†êË®≠ÂêçÁ®±
                        const defaultName = defaultNames[i] || `ÈÜ´Â∏´${i+1}`;
                        this.staff.push({
                            id: i,
                            name: defaultName,
                            leaveRequests: []
                        });
                    }
                }
                
                this.renderStaffGrid();
                this.generateRequirements();
            }

            generateRequirements() {
                this.requirements = {};
                for (let day = 1; day <= this.daysInMonth; day++) {
                    this.requirements[day] = {
                        dayShift: 2,
                        nightShift: day === this.daysInMonth ? 0 : 2
                    };
                }
                this.renderRequirements();
            }

            initializeEmptySchedule() {
                this.schedule = {};
                this.staff.forEach(staff => {
                    this.schedule[staff.id] = {};
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        this.schedule[staff.id][day] = {
                            dayShift: false,
                            nightShift: false,
                            leave: staff.leaveRequests.includes(day)
                        };
                    }
                });
            }

            renderStaffGrid() {
                const grid = document.getElementById('staffGrid');
                grid.innerHTML = '';
                
                this.staff.forEach(staff => {
                    const card = document.createElement('div');
                    card.className = 'staff-card';
                    card.innerHTML = `
                        <div class="staff-header">
                            <div class="control-group" style="margin-bottom: 10px;">
                                <label>Âì°Â∑•ÂßìÂêç</label>
                                <input type="text" 
                                       value="${staff.name}"
                                       onchange="scheduler.updateStaffName(${staff.id}, this.value)"
                                       placeholder="Ë´ãËº∏ÂÖ•Âì°Â∑•ÂßìÂêç"
                                       style="font-weight: 600; background: #fff; border: 2px solid #dee2e6;">
                            </div>
                        </div>
                        <div class="control-group">
                            <label>Ë´ãÂÅáÊó•Êúü (‰ª•ÈÄóËôüÂàÜÈöîÔºåÂ¶Ç: 5,12,20)</label>
                            <input type="text" 
                                   value="${staff.leaveRequests.join(',')}"
                                   onchange="scheduler.updateLeave(${staff.id}, this.value)"
                                   placeholder="Ë´ãËº∏ÂÖ•Ë´ãÂÅáÊó•Êúü">
                        </div>
                        <div class="leave-dates">
                            ${staff.leaveRequests.map(date => 
                                `<span class="leave-tag">${date}Êó•</span>`
                            ).join('')}
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }

            renderRequirements() {
                this.renderRequirementsSummary();
                this.renderLeaveAnalysis();
                this.renderRequirementsGrid();
            }

            renderRequirementsSummary() {
                const summary = document.getElementById('requirementsSummary');
                
                let totalDayShifts = 0;
                let totalNightShifts = 0;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    totalDayShifts += this.requirements[day].dayShift;
                    totalNightShifts += this.requirements[day].nightShift;
                }
                
                const avgDayShifts = (totalDayShifts / this.staff.length).toFixed(1);
                const avgNightShifts = (totalNightShifts / this.staff.length).toFixed(1);
                
                summary.innerHTML = `
                    <div class="summary-card">
                        <div class="summary-value">${totalDayShifts}</div>
                        <div class="summary-label">Á∏ΩÁôΩÁè≠ÈúÄÊ±Ç</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${totalNightShifts}</div>
                        <div class="summary-label">Á∏ΩÂ§úÁè≠ÈúÄÊ±Ç</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${avgDayShifts}</div>
                        <div class="summary-label">Âπ≥ÂùáÁôΩÁè≠/‰∫∫</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${avgNightShifts}</div>
                        <div class="summary-label">Âπ≥ÂùáÂ§úÁè≠/‰∫∫</div>
                    </div>
                `;
            }

            renderLeaveAnalysis() {
                const analysis = document.getElementById('leaveAnalysis');
                
                // Ë®àÁÆóÊØèÂ§©ÁöÑË´ãÂÅá‰∫∫Êï∏
                const leaveCounts = {};
                for (let day = 1; day <= this.daysInMonth; day++) {
                    leaveCounts[day] = 0;
                }
                
                this.staff.forEach(staff => {
                    staff.leaveRequests.forEach(day => {
                        if (day >= 1 && day <= this.daysInMonth) {
                            leaveCounts[day]++;
                        }
                    });
                });
                
                // ÊâæÂá∫Ë´ãÂÅá‰∫∫Êï∏ËºÉÂ§öÁöÑÊó•Êúü
                const highLeaveDays = [];
                const mediumLeaveDays = [];
                const lowLeaveDays = [];
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const count = leaveCounts[day];
                    const dayName = this.getDayOfWeek(day);
                    const dayInfo = `${day}Êó•(${dayName})`;
                    
                    if (count >= 3) {
                        highLeaveDays.push({ day: dayInfo, count });
                    } else if (count === 2) {
                        mediumLeaveDays.push({ day: dayInfo, count });
                    } else if (count === 1) {
                        lowLeaveDays.push({ day: dayInfo, count });
                    }
                }
                
                if (highLeaveDays.length === 0 && mediumLeaveDays.length === 0 && lowLeaveDays.length === 0) {
                    analysis.innerHTML = `
                        <div class="leave-analysis">
                            <h4>üìä Ë´ãÂÅáÂàÜÊûê</h4>
                            <p style="color: #28a745; margin: 0;">ÁõÆÂâçÊ≤íÊúâÂì°Â∑•Ë´ãÂÅáÔºå‰∫∫ÂäõÂÖÖË∂≥ÔºÅ</p>
                        </div>
                    `;
                    return;
                }
                
                analysis.innerHTML = `
                    <div class="leave-analysis">
                        <h4>üìä Ë´ãÂÅáÂàÜÊûê - Âª∫Ë≠∞Ë™øÊï¥‰∫∫ÂäõÈúÄÊ±Ç</h4>
                        <div class="high-leave-days">
                            ${highLeaveDays.map(item => 
                                `<span class="leave-day-tag">${item.day}: ${item.count}‰∫∫Ë´ãÂÅá</span>`
                            ).join('')}
                            ${mediumLeaveDays.map(item => 
                                `<span class="leave-day-tag medium">${item.day}: ${item.count}‰∫∫Ë´ãÂÅá</span>`
                            ).join('')}
                            ${lowLeaveDays.map(item => 
                                `<span class="leave-day-tag low">${item.day}: ${item.count}‰∫∫Ë´ãÂÅá</span>`
                            ).join('')}
                        </div>
                        ${highLeaveDays.length > 0 ? 
                            `<p style="margin-top: 10px; color: #856404; font-size: 14px;">
                                ‚ö†Ô∏è Á¥ÖËâ≤Ê®ôË®òÁöÑÊó•ÊúüË´ãÂÅá‰∫∫Êï∏ËºÉÂ§öÔºåÂª∫Ë≠∞ÈÅ©Áï∂Èôç‰ΩéÁï∂Â§©ÁöÑ‰∫∫ÂäõÈúÄÊ±Ç‰ª•ÊèêÈ´òÊéíÁè≠ÊàêÂäüÁéá
                            </p>` : ''
                        }
                    </div>
                `;
            }

            renderRequirementsGrid() {
                const grid = document.getElementById('requirementsGrid');
                grid.innerHTML = '';
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const card = document.createElement('div');
                    const isWeekendDay = this.isWeekend(day);
                    const dayName = this.getDayOfWeek(day);
                    
                    // Ë®àÁÆóÁï∂Â§©Ë´ãÂÅá‰∫∫Êï∏
                    const leaveCount = this.staff.filter(staff => 
                        staff.leaveRequests.includes(day)
                    ).length;
                    
                    card.className = `day-requirement ${isWeekendDay ? 'weekend' : ''}`;
                    card.innerHTML = `
                        <strong>${day}Êó• (${dayName})</strong>
                        ${leaveCount > 0 ? `<div style="color: #dc3545; font-size: 11px; margin: 2px 0;">${leaveCount}‰∫∫Ë´ãÂÅá</div>` : ''}
                        <div style="margin: 8px 0;">
                            <label>ÁôΩÁè≠</label>
                            <input type="number" min="1" max="3" 
                                   value="${this.requirements[day].dayShift}"
                                   onchange="scheduler.updateRequirement(${day}, 'dayShift', this.value)"
                                   style="width: 50px; margin-left: 5px;">
                        </div>
                        <div>
                            <label>Â§úÁè≠</label>
                            <input type="number" min="0" max="3" 
                                   value="${this.requirements[day].nightShift}"
                                   onchange="scheduler.updateRequirement(${day}, 'nightShift', this.value)"
                                   style="width: 50px; margin-left: 5px;"
                                   ${day === this.daysInMonth ? 'disabled' : ''}>
                        </div>
                    `;
                    grid.appendChild(card);
                }
            }

            updateLeave(staffId, leaveStr) {
                const leaves = leaveStr.split(',')
                    .map(s => parseInt(s.trim()))
                    .filter(n => !isNaN(n) && n >= 1 && n <= this.daysInMonth);
                
                this.staff[staffId].leaveRequests = leaves;
                this.renderStaffGrid();
                
                // ÈáçÊñ∞Ê∏≤ÊüìË´ãÂÅáÂàÜÊûêÂíåÈúÄÊ±ÇÁ∂≤Ê†º
                this.renderLeaveAnalysis();
                this.renderRequirementsGrid();
                
                // Â¶ÇÊûúÂ∑≤Á∂ìÊúâÊéíÁè≠Ë°®ÔºåÈúÄË¶ÅÊõ¥Êñ∞ÊéíÁè≠Ë°®‰∏≠ÁöÑË´ãÂÅáÁãÄÊÖã
                if (this.schedule && Object.keys(this.schedule).length > 0) {
                    this.initializeEmptySchedule();
                    this.renderSchedule();
                }
            }

            updateStaffName(staffId, newName) {
                if (newName && newName.trim()) {
                    this.staff[staffId].name = newName.trim();
                    
                    // Â¶ÇÊûúÂ∑≤Á∂ìÊúâÊéíÁè≠Ë°®ÔºåÈúÄË¶ÅÈáçÊñ∞Ê∏≤Êüì‰ª•È°ØÁ§∫Êñ∞ÂêçÂ≠ó
                    if (this.schedule && Object.keys(this.schedule).length > 0) {
                        this.renderSchedule();
                        this.renderStats();
                    }
                }
            }

            updateRequirement(day, shift, value) {
                this.requirements[day][shift] = parseInt(value);
                // Êõ¥Êñ∞ÈúÄÊ±ÇÂæåÈáçÊñ∞Ê∏≤ÊüìÁµ±Ë®à
                this.renderRequirementsSummary();
            }

            generateSchedule() {
                console.log('=== ÈñãÂßãÂÆåÊï¥ÊéíÁè≠ÊµÅÁ®ã ===');
                
                // Ê∏ÖÁ©∫‰πãÂâçÁöÑÊéíÁè≠ÁµêÊûú
                this.schedule = {};
                this.conflicts = [];
                
                // ÂàùÂßãÂåñÊéíÁè≠Ë°®
                this.staff.forEach(staff => {
                    this.schedule[staff.id] = {};
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        this.schedule[staff.id][day] = {
                            dayShift: false,
                            nightShift: false,
                            leave: staff.leaveRequests.includes(day)
                        };
                    }
                });

                // 1. ÂÖàÊéíÂ§úÁè≠
                const nightShiftSuccess = this.scheduleNightShifts();
                
                if (!nightShiftSuccess) {
                    console.log('‚ùå Â§úÁè≠ÊéíÁè≠Â§±ÊïóÔºåÁÑ°Ê≥ïÁî¢ÁîüÊúâÊïàÊéíÁè≠Ë°®');
                    this.renderAll();
                    return;
                }

                console.log('‚úÖ Â§úÁè≠ÊéíÁè≠ÂÆåÊàêÔºåÈñãÂßãÊéíÁôΩÁè≠');
                
                // 2. ÂÜçÊéíÁôΩÁè≠
                const dayShiftSuccess = this.scheduleDayShifts();
                
                if (!dayShiftSuccess) {
                    console.log('‚ùå ÁôΩÁè≠ÊéíÁè≠Â§±ÊïóÔºå‰ΩÜÂ§úÁè≠Â∑≤ÂÆåÊàê');
                } else {
                    console.log('‚úÖ ÁôΩÁè≠ÊéíÁè≠ÂÆåÊàê');
                }
                
                this.renderAll();
            }

            scheduleNightShifts() {
                console.log('=== ÈñãÂßãÂ§úÁè≠ÊéíÁè≠ ===');
                
                let maxAttempts = 1000;
                let bestSchedule = null;
                let bestBalance = Infinity;
                let perfectBalanceCount = 0;
                
                // Ë®àÁÆóÁ∏ΩÂ§úÁè≠ÈúÄÊ±Ç
                const totalNightShiftsNeeded = Object.values(this.requirements)
                    .reduce((sum, req) => sum + req.nightShift, 0);
                const targetNightShiftsPerPerson = Math.floor(totalNightShiftsNeeded / this.staff.length);
                
                console.log(`Á∏ΩÂ§úÁè≠ÈúÄÊ±Ç: ${totalNightShiftsNeeded}Áè≠`);
                console.log(`ÁõÆÊ®ôÊØè‰∫∫Â§úÁè≠Êï∏: ${targetNightShiftsPerPerson}Áè≠`);
                console.log(`ÈñãÂßãÈÄ≤Ë°åÊúÄÂ§ö${maxAttempts}Ê¨°Â§úÁè≠ÊéíÁè≠ÂòóË©¶ÔºåÁõÆÊ®ôÔºöÊØèÂÄã‰∫∫${targetNightShiftsPerPerson}Áè≠`);
                
                for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                    this.clearNightShifts();
                    
                    // ÈáçÁΩÆÂ§úÁè≠Ë®àÊï∏
                    this.staff.forEach(staff => {
                        staff.currentNightShifts = 0;
                    });
                    
                    // ÈÄêÊó•ÂÆâÊéíÂ§úÁè≠
                    for (let day = 1; day <= this.daysInMonth - 1; day++) {
                        const needed = this.requirements[day].nightShift;
                        if (needed === 0) continue;
                        
                        const selectedStaff = this.selectStaffForNightShift(day, needed, targetNightShiftsPerPerson);
                        
                        selectedStaff.forEach(staff => {
                            this.schedule[staff.id][day].nightShift = true;
                            staff.currentNightShifts++;
                        });
                    }
                    
                    const balance = this.calculateNightShiftBalance();
                    
                    if (attempt % 50 === 0 || balance === 0) {
                        console.log(`Á¨¨${attempt}Ê¨°Â§úÁè≠ÂòóË©¶ - ÊúÄÂ§ßÂ∑ÆË∑ù: ${balance}Áè≠`);
                    }
                    
                    if (balance < bestBalance) {
                        bestBalance = balance;
                        bestSchedule = this.copyCurrentSchedule();
                        console.log(`üéØ ÁôºÁèæÊõ¥‰Ω≥Â§úÁè≠ÊñπÊ°àÔºÅÊúÄÂ§ßÂ∑ÆË∑ù: ${balance}Áè≠ (Á¨¨${attempt}Ê¨°ÂòóË©¶)`);
                    }
                    
                    if (balance === 0) {
                        perfectBalanceCount++;
                        if (perfectBalanceCount >= 3) {
                            console.log(`üéâ ÈÄ£Á∫åÊâæÂà∞${perfectBalanceCount}Ê¨°ÂÆåÂÖ®Âπ≥Ë°°Â§úÁè≠ÊñπÊ°àÔºÅÊØè‰∫∫${targetNightShiftsPerPerson}Áè≠`);
                            break;
                        }
                    }
                    
                    if (bestBalance <= 1 && attempt >= 200) {
                        console.log(`‚úÖ Â∑≤ÊâæÂà∞Â∑ÆË∑ù${bestBalance}Áè≠ÁöÑËâØÂ•ΩÂ§úÁè≠ÊñπÊ°à`);
                        break;
                    }
                }
                
                if (bestSchedule && bestBalance === 0) {
                    this.restoreSchedule(bestSchedule);
                    console.log(`üèÜ Êé°Áî®ÂÆåÂÖ®Âπ≥Ë°°Â§úÁè≠ÊñπÊ°à - Â∑ÆË∑ù: ${bestBalance}Áè≠ÔºåÊØè‰∫∫${targetNightShiftsPerPerson}Áè≠`);
                    return true;
                } else {
                    console.log('‚ùå Êú™ÊâæÂà∞ÂÆåÂÖ®Âπ≥Ë°°Â§úÁè≠ÊñπÊ°à');
                    return false;
                }
            }

            scheduleDayShifts() {
                console.log('=== ÈñãÂßãÁôΩÁè≠ÊéíÁè≠ ===');
                
                let maxAttempts = 1000;
                let bestSchedule = null;
                let bestBalance = Infinity;
                let bestFulfillment = 0;
                let bestAverageCount = 0;
                
                // Ë®àÁÆóÁ∏ΩÁôΩÁè≠Êï∏ÂíåÂπ≥ÂùáÂÄº
                const totalDayShiftsNeeded = Object.values(this.requirements)
                    .reduce((sum, req) => sum + req.dayShift, 0);
                const averageDayShifts = Math.round(totalDayShiftsNeeded / this.staff.length);
                const targetPeopleCount = this.staff.length - 3; // N-3ÂÄã‰∫∫ÈÅîÂà∞Âπ≥Âùá
                
                console.log(`ÈñãÂßãÈÄ≤Ë°åÊúÄÂ§ö${maxAttempts}Ê¨°ÁôΩÁè≠ÊéíÁè≠ÂòóË©¶`);
                console.log(`ÁõÆÊ®ôÔºö${targetPeopleCount}‰∫∫ÈÅîÂà∞Âπ≥Âùá${averageDayShifts}Áè≠Âç≥ÁÇ∫ÊúÄ‰Ω≥Ëß£`);
                
                for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                    // Âè™Ê∏ÖÁ©∫ÁôΩÁè≠Ôºå‰øùÁïôÂ§úÁè≠
                    this.clearDayShifts();
                    
                    // ÈáçÁΩÆÁôΩÁè≠Ë®àÊï∏
                    this.staff.forEach(staff => {
                        staff.currentDayShifts = 0;
                    });
                    
                    // ‰ΩøÁî®Âπ≥Ë°°ÂÑ™ÂÖàÁöÑÊéíÁè≠Á≠ñÁï•
                    this.assignDayShiftsBalanced();
                    
                    const balance = this.calculateDayShiftBalance();
                    const fulfillment = this.calculateDayShiftFulfillment();
                    const averageAchievers = this.countPeopleAtAverageDayShifts(averageDayShifts);
                    
                    if (attempt % 50 === 0 || averageAchievers >= targetPeopleCount || attempt <= 3) {
                        console.log(`Á¨¨${attempt}Ê¨°ÁôΩÁè≠ÂòóË©¶ - Â∑ÆË∑ù: ${balance}Áè≠, ÊªøË∂≥: ${fulfillment.toFixed(1)}%, ÈÅîÂπ≥Âùá‰∫∫Êï∏: ${averageAchievers}/${this.staff.length}`);
                    }
                    
                    // ÂÑ™ÂÖàËÄÉÊÖÆÈÅîÂà∞Âπ≥ÂùáÁöÑ‰∫∫Êï∏ÔºåÂÖ∂Ê¨°ËÄÉÊÖÆÂπ≥Ë°°ÊÄßÔºåÊúÄÂæåËÄÉÊÖÆÈúÄÊ±ÇÊªøË∂≥Â∫¶
                    const isBetter = averageAchievers > bestAverageCount || 
                                   (averageAchievers === bestAverageCount && balance < bestBalance) ||
                                   (averageAchievers === bestAverageCount && balance === bestBalance && fulfillment > bestFulfillment);
                    
                    if (isBetter) {
                        bestBalance = balance;
                        bestFulfillment = fulfillment;
                        bestAverageCount = averageAchievers;
                        bestSchedule = this.copyCurrentDaySchedule();
                        if (attempt <= 10 || averageAchievers >= targetPeopleCount) {
                            console.log(`üéØ ÁôºÁèæÊõ¥‰Ω≥ÁôΩÁè≠ÊñπÊ°àÔºÅÈÅîÂπ≥Âùá: ${averageAchievers}‰∫∫, Â∑ÆË∑ù: ${balance}Áè≠, ÊªøË∂≥: ${fulfillment.toFixed(1)}%`);
                        }
                    }
                    
                    // Â¶ÇÊûúÈÅîÂà∞ÁõÆÊ®ô‰∫∫Êï∏ÔºåÊèêÂâçÁµêÊùü
                    if (averageAchievers >= targetPeopleCount) {
                        console.log(`üéâ ÈÅîÊàêÁõÆÊ®ôÔºÅ${averageAchievers}‰∫∫ÈÅîÂà∞Âπ≥Âùá${averageDayShifts}Áè≠`);
                        break;
                    }
                    
                    // Â¶ÇÊûúÊâæÂà∞‰∫ÜÂæàÂ•ΩÁöÑÊñπÊ°à‰∏îÂòóË©¶Ë∂ÖÈÅé500Ê¨°Ôºå‰πüÂèØ‰ª•ËÄÉÊÖÆÊèêÂâçÁµêÊùü
                    if (averageAchievers >= targetPeopleCount - 1 && balance <= 2 && attempt >= 500) {
                        console.log(`‚úÖ ÊâæÂà∞Êé•ËøëÁõÆÊ®ôÁöÑÊñπÊ°à - ÈÅîÂπ≥Âùá: ${averageAchievers}‰∫∫, Â∑ÆË∑ù: ${balance}Áè≠`);
                        break;
                    }
                }
                
                if (bestSchedule) {
                    this.restoreDaySchedule(bestSchedule);
                    console.log(`üèÜ Êé°Áî®ÊúÄ‰Ω≥ÁôΩÁè≠ÊñπÊ°à - ÈÅîÂπ≥Âùá: ${bestAverageCount}‰∫∫, Â∑ÆË∑ù: ${bestBalance}Áè≠, ÊªøË∂≥: ${bestFulfillment.toFixed(1)}%`);
                    this.reportDayShiftDistribution(averageDayShifts);
                    this.checkConflicts();
                    this.renderStats();
                    return true;
                } else {
                    console.log('‚ùå Êú™ÊâæÂà∞ÂèØË°åÁôΩÁè≠ÊñπÊ°à');
                    return false;
                }
            }

            assignDayShiftsBalanced() {
                // Ë®àÁÆóÁõÆÊ®ôÂ§úÁè≠Êï∏ÔºåÁî®ÊñºÊ±∫ÂÆöÈÄ£Á∫åÂ∑•‰ΩúÂ§©Êï∏ÈôêÂà∂
                const totalNightShiftsNeeded = Object.values(this.requirements)
                    .reduce((sum, req) => sum + req.nightShift, 0);
                const targetNightShifts = Math.floor(totalNightShiftsNeeded / this.staff.length);
                const maxConsecutiveDays = targetNightShifts; // Ê†πÊìöÂ§úÁè≠Âπ≥ÂùáÊï∏Ë®≠ÂÆöÈÄ£Á∫åÂ∑•‰ΩúÈôêÂà∂
                
                console.log(`ÁôΩÁè≠ÊéíÁè≠ - ÁõÆÊ®ôÂ§úÁè≠Êï∏: ${targetNightShifts}Áè≠ÔºåÈÄ£Á∫åÂ∑•‰ΩúÈôêÂà∂: ${maxConsecutiveDays}Â§©`);
                
                // ÈÄêÊó•ÂÆâÊéíÁôΩÁè≠Ôºå‰ΩøÁî®Âπ≥Ë°°Á≠ñÁï•
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const needed = this.requirements[day].dayShift;
                    if (needed === 0) continue;
                    
                    // Áç≤ÂèñÂèØÂ∑•‰Ωú‰∫∫Âì°‰∏¶ÊåâÁôΩÁè≠Êï∏ÊéíÂ∫èÔºàÂ∞ëÁöÑÂÑ™ÂÖàÔºâ
                    const availableStaff = this.getAvailableStaffForDay(day, maxConsecutiveDays);
                    
                    if (availableStaff.length === 0) {
                        continue; // Ê≤íÊúâÂèØÁî®‰∫∫Âì°
                    }
                    
                    // ÊåâÁï∂ÂâçÁôΩÁè≠Êï∏ÊéíÂ∫èÔºåÁè≠Êï∏Â∞ëÁöÑÂÑ™ÂÖà
                    availableStaff.sort((a, b) => {
                        const aDayShifts = a.currentDayShifts || 0;
                        const bDayShifts = b.currentDayShifts || 0;
                        if (aDayShifts !== bDayShifts) {
                            return aDayShifts - bDayShifts; // Áè≠Êï∏Â∞ëÁöÑÂÑ™ÂÖà
                        }
                        // Â¶ÇÊûúÁè≠Êï∏Áõ∏ÂêåÔºåÈö®Ê©üÊéíÂ∫è
                        return Math.random() - 0.5;
                    });
                    
                    // ÈÅ∏ÊìáÂâçNÂêç
                    const selectedCount = Math.min(needed, availableStaff.length);
                    const selectedStaff = availableStaff.slice(0, selectedCount);
                    
                    // ÂàÜÈÖçÁôΩÁè≠
                    selectedStaff.forEach(staff => {
                        this.schedule[staff.id][day].dayShift = true;
                        staff.currentDayShifts = (staff.currentDayShifts || 0) + 1;
                    });
                }
            }

            getAvailableStaffForDay(day, maxConsecutiveDays = 6) {
                const availableStaff = [];
                
                this.staff.forEach(staff => {
                    // Ê™¢Êü•Âü∫Êú¨ÂèØÂ∑•‰ΩúÊ¢ù‰ª∂
                    const isOnLeave = this.schedule[staff.id][day].leave;
                    const alreadyDayShift = this.schedule[staff.id][day].dayShift;
                    const hasNightToday = this.schedule[staff.id][day].nightShift;
                    const hadNightYesterday = day > 1 && this.schedule[staff.id][day-1].nightShift;
                    
                    // ÁµïÂ∞ç‰∏çËÉΩÈÅïÂèçÁöÑÊ¢ù‰ª∂
                    if (isOnLeave) return;           // Ë´ãÂÅá
                    if (alreadyDayShift) return;     // Â∑≤ÊúâÁôΩÁè≠
                    if (hasNightToday) return;       // Áï∂Â§©Â§úÁè≠
                    if (hadNightYesterday) return;   // Ââç‰∏ÄÊó•Â§úÁè≠
                    
                    // Ê™¢Êü•ÈÄ£Á∫åÂ∑•‰ΩúÂ§©Êï∏ÔºàÂãïÊÖãÈôêÂà∂Ôºâ
                    const consecutiveDays = this.getConsecutiveDays(staff.id, day);
                    if (consecutiveDays >= maxConsecutiveDays) return;
                    
                    // ÈÄöÈÅéÊ™¢Êü•ÁöÑ‰∫∫Âì°
                    availableStaff.push(staff);
                });
                
                return availableStaff;
            }

            countPeopleAtAverageDayShifts(averageDayShifts) {
                return this.staff.filter(staff => 
                    (staff.currentDayShifts || 0) === averageDayShifts
                ).length;
            }

            reportDayShiftDistribution(averageDayShifts) {
                console.log('\n=== ÁôΩÁè≠ÂàÜÈÖçÁµêÊûú ===');
                
                // ÊåâÁè≠Êï∏ÂàÜÁµÑÈ°ØÁ§∫
                const countGroups = {};
                this.staff.forEach(staff => {
                    const count = staff.currentDayShifts || 0;
                    if (!countGroups[count]) countGroups[count] = [];
                    countGroups[count].push(staff.name);
                });
                
                const dayCounts = this.staff.map(staff => staff.currentDayShifts || 0);
                const minDays = Math.min(...dayCounts);
                const maxDays = Math.max(...dayCounts);
                const totalDays = dayCounts.reduce((sum, count) => sum + count, 0);
                const avgDays = totalDays / this.staff.length;
                
                console.log(`Á∏ΩÁôΩÁè≠Êï∏: ${totalDays}Áè≠`);
                console.log(`Âπ≥ÂùáÁè≠Êï∏: ${avgDays.toFixed(1)}Áè≠`);
                console.log(`Áè≠Êï∏ÁØÑÂúç: ${minDays} - ${maxDays}Áè≠`);
                console.log(`ÊúÄÂ§ßÂ∑ÆË∑ù: ${maxDays - minDays}Áè≠`);
                
                console.log('\nÁè≠Êï∏ÂàÜÂ∏É:');
                for (let count = minDays; count <= maxDays; count++) {
                    if (countGroups[count]) {
                        const isAverage = count === averageDayShifts;
                        const marker = isAverage ? '‚≠ê' : '  ';
                        console.log(`${marker}${count}Áè≠: ${countGroups[count].join(', ')} (${countGroups[count].length}‰∫∫)`);
                    }
                }
                
                const averageAchievers = this.countPeopleAtAverageDayShifts(averageDayShifts);
                const targetPeopleCount = this.staff.length - 3;
                
                console.log(`\n‚≠ê ÈÅîÂà∞Âπ≥Âùá${averageDayShifts}Áè≠ÁöÑ‰∫∫Êï∏: ${averageAchievers}/${this.staff.length}`);
                console.log(`üéØ ÁõÆÊ®ô‰∫∫Êï∏: ${targetPeopleCount}‰∫∫`);
                
                if (averageAchievers >= targetPeopleCount) {
                    console.log('üéâ ÈÅîÊàêÁõÆÊ®ôÔºÅÂ§ßÈÉ®ÂàÜ‰∫∫ÈÉΩÈÅîÂà∞Âπ≥ÂùáÁè≠Êï∏');
                } else if (averageAchievers >= targetPeopleCount - 1) {
                    console.log('üåü Êé•ËøëÁõÆÊ®ôÔºÅÂàÜÈÖçÁõ∏Áï∂ÂùáÂãª');
                } else {
                    console.log('‚ö†Ô∏è Êú™ÈÅîÁõÆÊ®ôÔºå‰ΩÜÂ∑≤ÊòØÁï∂ÂâçÊúÄ‰Ω≥ÊñπÊ°à');
                }
            }

            selectStaffForNightShift(day, needed, targetNightShifts = 5) {
                const groups = this.groupStaffByNightPriority(day, targetNightShifts);
                
                const selectedStaff = [];
                
                // ÂÑ™ÂÖàÂæûÈ´òÂÑ™ÂÖàÁ¥öÈÅ∏Êìá
                if (groups.high.length > 0) {
                    const highPicks = Math.min(needed, groups.high.length);
                    const shuffled = this.shuffleArray([...groups.high]);
                    selectedStaff.push(...shuffled.slice(0, highPicks));
                }
                
                // Â¶ÇÊûúÈÇÑÈúÄË¶Å‰∫∫ÔºåÂæû‰∏≠ÂÑ™ÂÖàÁ¥öÈÅ∏Êìá
                if (selectedStaff.length < needed && groups.medium.length > 0) {
                    const mediumNeeded = needed - selectedStaff.length;
                    const mediumPicks = Math.min(mediumNeeded, groups.medium.length);
                    const shuffled = this.shuffleArray([...groups.medium]);
                    selectedStaff.push(...shuffled.slice(0, mediumPicks));
                }
                
                // ÊúÄÂæåÂæû‰ΩéÂÑ™ÂÖàÁ¥öÈÅ∏Êìá
                if (selectedStaff.length < needed && groups.low.length > 0) {
                    const lowNeeded = needed - selectedStaff.length;
                    const lowPicks = Math.min(lowNeeded, groups.low.length);
                    const shuffled = this.shuffleArray([...groups.low]);
                    selectedStaff.push(...shuffled.slice(0, lowPicks));
                }
                
                return selectedStaff;
            }

            groupStaffByNightPriority(day, targetNightShifts = 5) {
                const groups = { high: [], medium: [], low: [] };
                
                this.staff.forEach(staff => {
                    if (!this.canWorkNightShift(staff.id, day)) {
                        return;
                    }
                    
                    const nightShifts = staff.currentNightShifts;
                    const hadNightYesterday = day > 1 && this.schedule[staff.id][day-1].nightShift;
                    
                    // È´òÂÑ™ÂÖàÁ¥öÔºöÂ§úÁè≠Êï∏Â∞ëÊñºÁõÆÊ®ô‰∏îÂâç‰∏ÄÂ§©‰πüÊòØÂ§úÁè≠ÔºàÈÄ£Á∫åÂ§úÁè≠Ôºâ
                    if (nightShifts < targetNightShifts && hadNightYesterday) {
                        groups.high.push(staff);
                    }
                    // ‰∏≠ÂÑ™ÂÖàÁ¥öÔºöÂ§úÁè≠Êï∏Â∞ëÊñºÁõÆÊ®ô
                    else if (nightShifts < targetNightShifts) {
                        groups.medium.push(staff);
                    }
                    // ‰ΩéÂÑ™ÂÖàÁ¥öÔºöÂ∑≤ÈÅîÂà∞ÊàñË∂ÖÈÅéÁõÆÊ®ôÂ§úÁè≠Êï∏
                    else {
                        groups.low.push(staff);
                    }
                });
                
                return groups;
            }

            canWorkNightShift(staffId, day) {
                if (this.schedule[staffId][day].leave) return false;
                if (this.schedule[staffId][day].nightShift) return false;
                if (day === this.daysInMonth) return false;
                
                const staff = this.staff.find(s => s.id === staffId);
                if (staff && staff.leaveRequests.includes(day + 1)) return false;
                
                return true;
            }

            canWorkDayShift(staffId, day) {
                if (this.schedule[staffId][day].leave) return false;
                if (this.schedule[staffId][day].dayShift) return false;
                
                // Â§úÁè≠Âæå‰∏çËÉΩÊé•ÁôΩÁè≠ÔºàËá≥Â∞ëÈñìÈöî12Â∞èÊôÇÔºâ
                if (day > 1 && this.schedule[staffId][day-1].nightShift) return false;
                
                // ÂãïÊÖãË®àÁÆóÈÄ£Á∫åÂ∑•‰ΩúÂ§©Êï∏ÈôêÂà∂
                const totalNightShiftsNeeded = Object.values(this.requirements)
                    .reduce((sum, req) => sum + req.nightShift, 0);
                const targetNightShifts = Math.floor(totalNightShiftsNeeded / this.staff.length);
                const maxConsecutiveDays = targetNightShifts; // Ê†πÊìöÂ§úÁè≠Âπ≥ÂùáÊï∏Ë®≠ÂÆö
                
                // Ê™¢Êü•ÈÄ£Á∫åÂ∑•‰ΩúÂ§©Êï∏
                const consecutiveDays = this.getConsecutiveDays(staffId, day);
                if (consecutiveDays >= maxConsecutiveDays) return false;
                
                return true;
            }

            getConsecutiveDays(staffId, currentDay) {
                let consecutiveDays = 0;
                
                // ÂæÄÂâçÊü•ÁúãÈÄ£Á∫åÂ∑•‰ΩúÂ§©Êï∏
                for (let day = currentDay - 1; day >= 1; day--) {
                    const hasWork = this.schedule[staffId][day].dayShift || this.schedule[staffId][day].nightShift;
                    if (hasWork) {
                        consecutiveDays++;
                    } else {
                        break;
                    }
                }
                
                return consecutiveDays;
            }

            clearNightShifts() {
                this.staff.forEach(staff => {
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        if (this.schedule[staff.id] && this.schedule[staff.id][day]) {
                            this.schedule[staff.id][day].nightShift = false;
                        }
                    }
                });
            }

            clearDayShifts() {
                this.staff.forEach(staff => {
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        if (this.schedule[staff.id] && this.schedule[staff.id][day]) {
                            this.schedule[staff.id][day].dayShift = false;
                        }
                    }
                });
            }

            calculateNightShiftBalance() {
                const nightCounts = this.staff.map(staff => staff.currentNightShifts);
                const maxNights = Math.max(...nightCounts);
                const minNights = Math.min(...nightCounts);
                return maxNights - minNights;
            }

            calculateDayShiftBalance() {
                const dayCounts = this.staff.map(staff => staff.currentDayShifts || 0);
                const maxDays = Math.max(...dayCounts);
                const minDays = Math.min(...dayCounts);
                return maxDays - minDays;
            }

            calculateDayShiftFulfillment() {
                let totalRequired = 0;
                let totalAssigned = 0;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const required = this.requirements[day].dayShift;
                    const assigned = this.staff.filter(staff => 
                        this.schedule[staff.id][day].dayShift).length;
                    
                    totalRequired += required;
                    totalAssigned += assigned;
                }
                
                return totalRequired > 0 ? (totalAssigned / totalRequired) * 100 : 100;
            }

            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            copyCurrentSchedule() {
                const copy = {};
                this.staff.forEach(staff => {
                    copy[staff.id] = {};
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        copy[staff.id][day] = {
                            ...this.schedule[staff.id][day]
                        };
                    }
                });
                
                const staffCounts = {};
                this.staff.forEach(staff => {
                    staffCounts[staff.id] = {
                        nightShifts: staff.currentNightShifts,
                        dayShifts: staff.currentDayShifts || 0
                    };
                });
                
                return { schedule: copy, counts: staffCounts };
            }

            copyCurrentDaySchedule() {
                const copy = {};
                this.staff.forEach(staff => {
                    copy[staff.id] = {};
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        copy[staff.id][day] = {
                            dayShift: this.schedule[staff.id][day].dayShift,
                            nightShift: this.schedule[staff.id][day].nightShift,
                            leave: this.schedule[staff.id][day].leave
                        };
                    }
                });
                
                const staffCounts = {};
                this.staff.forEach(staff => {
                    staffCounts[staff.id] = staff.currentDayShifts || 0;
                });
                
                return { schedule: copy, counts: staffCounts };
            }

            restoreSchedule(saved) {
                this.schedule = saved.schedule;
                
                this.staff.forEach(staff => {
                    staff.currentNightShifts = saved.counts[staff.id].nightShifts;
                    staff.currentDayShifts = saved.counts[staff.id].dayShifts;
                });
            }

            restoreDaySchedule(saved) {
                // Âè™ÊÅ¢Âæ©ÁôΩÁè≠ÈÉ®ÂàÜÔºå‰øùÁïôÂ§úÁè≠
                this.staff.forEach(staff => {
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        this.schedule[staff.id][day].dayShift = saved.schedule[staff.id][day].dayShift;
                    }
                    staff.currentDayShifts = saved.counts[staff.id];
                });
            }

            checkConflicts() {
                this.conflicts = [];
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const dayShiftCount = this.staff.filter(staff => 
                        this.schedule[staff.id][day].dayShift).length;
                    const nightShiftCount = this.staff.filter(staff => 
                        this.schedule[staff.id][day].nightShift).length;
                    
                    if (dayShiftCount < this.requirements[day].dayShift) {
                        this.conflicts.push({
                            type: 'understaffed',
                            day: day,
                            shift: 'day',
                            needed: this.requirements[day].dayShift,
                            actual: dayShiftCount
                        });
                    }
                    
                    if (nightShiftCount < this.requirements[day].nightShift) {
                        this.conflicts.push({
                            type: 'understaffed',
                            day: day,
                            shift: 'night',
                            needed: this.requirements[day].nightShift,
                            actual: nightShiftCount
                        });
                    }
                    
                    // Ê™¢Êü•ÈÅïÂèçË¶èÂâáÁöÑÊÉÖÊ≥Å
                    this.staff.forEach(staff => {
                        const schedule = this.schedule[staff.id][day];
                        
                        // Ê™¢Êü•Â§úÁè≠ÂæåÊé•ÁôΩÁè≠
                        if (day > 1 && this.schedule[staff.id][day-1].nightShift && schedule.dayShift) {
                            this.conflicts.push({
                                type: 'rule_violation',
                                day: day,
                                staff: staff.name,
                                rule: 'Â§úÁè≠Âæå‰∏çËÉΩÊé•ÁôΩÁè≠'
                            });
                        }
                        
                        // Ê™¢Êü•Âêå‰∏ÄÂ§©Êó•Â§úÁè≠
                        if (schedule.dayShift && schedule.nightShift) {
                            this.conflicts.push({
                                type: 'rule_violation',
                                day: day,
                                staff: staff.name,
                                rule: 'Âêå‰∏ÄÂ§©‰∏çËÉΩÊó¢‰∏äÊó•Áè≠Âèà‰∏äÂ§úÁè≠'
                            });
                        }
                    });
                }
                
                this.renderConflicts();
            }

            renderConflicts() {
                const conflictList = document.getElementById('conflictList');
                
                if (this.conflicts.length === 0) {
                    conflictList.innerHTML = '';
                    return;
                }
                
                conflictList.innerHTML = `
                    <div class="conflict-list">
                        <h4>‚ö†Ô∏è ÊéíÁè≠ÂïèÈ°å</h4>
                        ${this.conflicts.map(conflict => {
                            if (conflict.type === 'understaffed') {
                                const shiftName = conflict.shift === 'day' ? 'ÁôΩÁè≠' : 'Â§úÁè≠';
                                return `<div class="conflict-item">
                                    ${conflict.day}Êó• ${shiftName} ‰∫∫Âäõ‰∏çË∂≥ÔºöÈúÄË¶Å${conflict.needed}‰∫∫ÔºåÂØ¶Èöõ${conflict.actual}‰∫∫
                                </div>`;
                            } else if (conflict.type === 'rule_violation') {
                                return `<div class="conflict-item">
                                    ${conflict.day}Êó• ${conflict.staff} ÈÅïÂèçË¶èÂâáÔºö${conflict.rule}
                                </div>`;
                            }
                            return '';
                        }).join('')}
                    </div>
                `;
            }

            renderSchedule() {
                const grid = document.getElementById('scheduleGrid');
                grid.innerHTML = '';
                
                if (!this.schedule || Object.keys(this.schedule).length === 0) {
                    grid.innerHTML = '<div class="grid-cell">Ë´ãÂÖàÈªûÊìä„ÄåËá™ÂãïÊéíÁè≠„ÄçÁîüÊàêÊéíÁè≠Ë°®</div>';
                    return;
                }
                
                // ÂãïÊÖãË®≠ÂÆöÁ∂≤Ê†ºÂàóÊï∏Ôºö1ÂàóÂì°Â∑•ÂêçÁ®± + NÂàóÊó•Êúü
                grid.style.gridTemplateColumns = `80px repeat(${this.daysInMonth}, 1fr)`;
                
                // Ë°®È†≠
                grid.appendChild(this.createCell('', 'grid-header'));
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const dayName = this.getDayOfWeek(day);
                    const isWeekendDay = this.isWeekend(day);
                    const headerClass = `day-header ${isWeekendDay ? 'weekend' : ''}`;
                    
                    const cell = document.createElement('div');
                    cell.className = headerClass;
                    cell.innerHTML = `
                        <div class="day-number">${day}</div>
                        <div class="day-name">${dayName}</div>
                    `;
                    grid.appendChild(cell);
                }
                
                // Âì°Â∑•ÊéíÁè≠
                this.staff.forEach(staff => {
                    grid.appendChild(this.createCell(staff.name, 'staff-name'));
                    
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        const schedule = this.schedule[staff.id] && this.schedule[staff.id][day] ? 
                            this.schedule[staff.id][day] : 
                            { dayShift: false, nightShift: false, leave: staff.leaveRequests.includes(day) };
                        
                        let cellClass = 'grid-cell';
                        let content = '';
                        
                        if (schedule.leave) {
                            cellClass += ' leave-day';
                            content = 'ÂÅá';
                        } else if (schedule.dayShift && schedule.nightShift) {
                            cellClass += ' shift-both';
                            content = 'Êó•Â§ú';
                        } else if (schedule.dayShift) {
                            cellClass += ' shift-day';
                            content = 'Êó•';
                        } else if (schedule.nightShift) {
                            cellClass += ' shift-night';
                            content = 'Â§ú';
                        }
                        
                        // Ê™¢Êü•ÊòØÂê¶ÊúâÈÅïË¶èÊÉÖÊ≥Å
                        const hasViolation = this.conflicts.some(c => 
                            c.type === 'rule_violation' && 
                            c.day === day && 
                            c.staff === staff.name
                        );
                        
                        if (hasViolation) {
                            cellClass += ' conflict';
                        }
                        
                        grid.appendChild(this.createCell(content, cellClass));
                    }
                });
            }

            createCell(content, className) {
                const cell = document.createElement('div');
                cell.className = className;
                cell.textContent = content;
                return cell;
            }

            renderStats() {
                const stats = document.getElementById('stats');
                
                if (!this.schedule || Object.keys(this.schedule).length === 0) {
                    stats.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-value">${this.staff.length}</div>
                            <div>Á∏ΩÂì°Â∑•Êï∏</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div>Á∏ΩÁè≠Ê¨°Êï∏</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div>Âπ≥ÂùáÁè≠Ê¨°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div>Â∑•ÊôÇÂ∑ÆÁï∞</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div>ÂïèÈ°åÊï∏Èáè</div>
                        </div>
                    `;
                    return;
                }
                
                const workloadDetails = this.staff.map(staff => {
                    const workload = this.getWorkload(staff.id);
                    const dayShifts = this.getDayShiftCount(staff.id);
                    const nightShifts = this.getNightShiftCount(staff.id);
                    const totalShifts = dayShifts + nightShifts;
                    return {
                        name: staff.name,
                        workload: workload,
                        dayShifts: dayShifts,
                        nightShifts: nightShifts,
                        totalShifts: totalShifts
                    };
                });
                
                const totalShifts = workloadDetails.reduce((sum, w) => sum + w.totalShifts, 0);
                const avgShifts = totalShifts / this.staff.length;
                const workloads = workloadDetails.map(w => w.workload);
                const maxWorkload = Math.max(...workloads);
                const minWorkload = Math.min(...workloads);
                
                const workloadTable = workloadDetails
                    .sort((a, b) => b.totalShifts - a.totalShifts)
                    .map(w => `<div style="display: flex; justify-content: space-between; padding: 8px 12px; background: ${w.totalShifts > avgShifts + 2 ? '#ffebee' : w.totalShifts < avgShifts - 2 ? '#e8f5e8' : '#f8f9fa'}; margin: 3px 0; border-radius: 6px; border: 1px solid #dee2e6;">
                        <span style="font-weight: 500; color: #212529;">${w.name}</span>
                        <span style="font-weight: 600; color: #495057;">${w.totalShifts}Áè≠ (Êó•:${w.dayShifts} Â§ú:${w.nightShifts})</span>
                    </div>`).join('');
                
                // Ë®àÁÆóÈúÄÊ±ÇÊªøË∂≥Áéá
                const dayShiftFulfillment = this.calculateDayShiftFulfillment();
                const nightShiftFulfillment = this.calculateNightShiftFulfillment();
                
                stats.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${this.staff.length}</div>
                        <div>Á∏ΩÂì°Â∑•Êï∏</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalShifts}</div>
                        <div>Á∏ΩÁè≠Ê¨°Êï∏</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${avgShifts.toFixed(1)}</div>
                        <div>Âπ≥ÂùáÁè≠Ê¨°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${((maxWorkload - minWorkload)/12).toFixed(1)}</div>
                        <div>Áè≠Ê¨°Â∑ÆÁï∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${this.conflicts.length}</div>
                        <div>ÂïèÈ°åÊï∏Èáè</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${dayShiftFulfillment.toFixed(1)}%</div>
                        <div>ÁôΩÁè≠ÊªøË∂≥Áéá</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${nightShiftFulfillment.toFixed(1)}%</div>
                        <div>Â§úÁè≠ÊªøË∂≥Áéá</div>
                    </div>
                    <div class="stat-card" style="grid-column: 1/-1;">
                        <h4 style="margin-bottom: 10px;">ÂÄã‰∫∫Â∑•‰ΩúË≤†Ëç∑</h4>
                        ${workloadTable}
                    </div>
                `;
            }

            calculateNightShiftFulfillment() {
                let totalRequired = 0;
                let totalAssigned = 0;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const required = this.requirements[day].nightShift;
                    const assigned = this.staff.filter(staff => 
                        this.schedule[staff.id][day].nightShift).length;
                    
                    totalRequired += required;
                    totalAssigned += assigned;
                }
                
                return totalRequired > 0 ? (totalAssigned / totalRequired) * 100 : 100;
            }

            getDayShiftCount(staffId) {
                let count = 0;
                if (!this.schedule || !this.schedule[staffId]) return 0;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const schedule = this.schedule[staffId][day];
                    if (schedule && schedule.dayShift) count++;
                }
                return count;
            }

            getNightShiftCount(staffId) {
                let count = 0;
                if (!this.schedule || !this.schedule[staffId]) return 0;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const schedule = this.schedule[staffId][day];
                    if (schedule && schedule.nightShift) count++;
                }
                return count;
            }

            getWorkload(staffId) {
                let workload = 0;
                if (!this.schedule || !this.schedule[staffId]) return 0;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const schedule = this.schedule[staffId][day];
                    if (!schedule) continue;
                    
                    if (schedule.dayShift) workload += 12;
                    if (schedule.nightShift) workload += 12;
                }
                return workload;
            }

            exportSchedule() {
                let csv = 'Âì°Â∑•ÂßìÂêç';
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const dayName = this.getDayOfWeek(day);
                    csv += `,${day}Êó•(${dayName})`;
                }
                csv += ',Á∏ΩÂ∑•ÊôÇ,Êó•Áè≠Ê¨°Êï∏,Â§úÁè≠Ê¨°Êï∏\n';
                
                this.staff.forEach(staff => {
                    csv += staff.name;
                    let totalHours = 0;
                    let dayCount = 0;
                    let nightCount = 0;
                    
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        const schedule = this.schedule[staff.id][day];
                        let cellValue = '';
                        
                        if (schedule.leave) {
                            cellValue = 'Ë´ãÂÅá';
                        } else if (schedule.dayShift && schedule.nightShift) {
                            cellValue = 'Êó•Â§úÁè≠';
                            totalHours += 24;
                            dayCount++;
                            nightCount++;
                        } else if (schedule.dayShift) {
                            cellValue = 'Êó•Áè≠';
                            totalHours += 12;
                            dayCount++;
                        } else if (schedule.nightShift) {
                            cellValue = 'Â§úÁè≠';
                            totalHours += 12;
                            nightCount++;
                        }
                        
                        csv += `,${cellValue}`;
                    }
                    
                    csv += `,${totalHours}Â∞èÊôÇ,${dayCount},${nightCount}\n`;
                });
                
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `ÊÄ•Ë®∫ÊéíÁè≠Ë°®_${this.currentMonth}.csv`;
                link.click();
            }

            renderAll() {
                this.renderStaffGrid();
                this.renderRequirements();
                this.renderSchedule();
                this.renderStats();
                this.renderConflicts();
            }
        }

        // ÂÖ®ÂüüÂáΩÊï∏
        const scheduler = new EmergencyScheduler();

        function generateStaffList() {
            scheduler.generateStaffList();
        }

        function generateSchedule() {
            scheduler.generateSchedule();
        }

        function exportSchedule() {
            scheduler.exportSchedule();
        }

        // Êë∫ÁñäÂäüËÉΩ
        window.toggleSection = function(sectionName) {
            const content = document.getElementById(sectionName + '-content');
            const icon = document.getElementById(sectionName + '-icon');
            
            if (content && icon) {
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    icon.classList.remove('collapsed');
                    icon.textContent = '‚ñº';
                } else {
                    content.classList.add('collapsed');
                    icon.classList.add('collapsed');
                    icon.textContent = '‚ñ∂';
                }
            }
        };

        // È†ÅÈù¢ËºâÂÖ•ÊôÇÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            scheduler.init();
        });

        // Êúà‰ªΩËÆäÊõ¥ÊôÇÊõ¥Êñ∞
        document.getElementById('monthSelect').addEventListener('change', () => {
            scheduler.init();
        });
    </script>
</body>
</html>
