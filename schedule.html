<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ€¥è¨ºæ’ç­ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header {
            background: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px 8px 0 0;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        input, select, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            background: #007bff;
            color: white;
            border: 1px solid #007bff;
            cursor: pointer;
            font-weight: 500;
        }

        button:hover {
            background: #0056b3;
        }

        .staff-section {
            background: white;
            padding: 0;
            border-bottom: 1px solid #dee2e6;
        }

        .section-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .section-header:hover {
            background: #e9ecef;
        }

        .section-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collapse-icon {
            font-size: 14px;
            transition: transform 0.2s;
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 20px;
            display: block;
        }

        .section-content.collapsed {
            display: none;
        }

        .requirements-section {
            background: white;
            padding: 0;
            border-bottom: 1px solid #dee2e6;
        }

        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .staff-header {
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .staff-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .staff-card h4 {
            color: #495057;
            margin-bottom: 10px;
        }

        .leave-dates {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .leave-tag {
            background: #fff3cd;
            color: #856404;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            border: 1px solid #ffeaa7;
        }

        .schedule-container {
            padding: 20px;
        }

        .schedule-grid {
            display: grid;
            gap: 1px;
            background: #ddd;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 15px;
        }

        .grid-header, .grid-cell {
            background: white;
            padding: 6px 4px;
            text-align: center;
            font-size: 12px;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .grid-header {
            background: #495057;
            color: white;
            font-weight: 600;
        }

        .day-header {
            background: #6c757d !important;
            color: white;
            font-weight: 600;
            min-height: 50px !important;
        }

        .day-header.weekend {
            background: #dc3545 !important;
            color: white;
        }

        .day-number {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .day-name {
            font-size: 10px;
            opacity: 0.9;
        }

        .staff-name {
            background: #495057 !important;
            color: white;
            font-weight: 600;
            justify-content: flex-start;
            padding-left: 8px;
        }

        .shift-day {
            background: #cce7ff;
            color: #004085;
            font-weight: 600;
        }

        .shift-night {
            background: #d4edda;
            color: #155724;
            font-weight: 600;
        }

        .shift-both {
            background: #ffeaa7;
            color: #856404;
            font-weight: 600;
        }

        .leave-day {
            background: #fff3cd;
            color: #856404;
        }

        .conflict {
            background: #f8d7da !important;
            color: #721c24;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .summary-card {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            text-align: center;
        }

        .summary-value {
            font-size: 20px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 12px;
            color: #6c757d;
        }

        .leave-analysis {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .leave-analysis h4 {
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .high-leave-days {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .leave-day-tag {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .leave-day-tag.medium {
            background: #fd7e14;
        }

        .leave-day-tag.low {
            background: #28a745;
        }

        .stat-card {
            background: #007bff;
            color: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .requirements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .day-requirement {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            text-align: center;
        }

        .day-requirement.weekend {
            background: #fff5f5;
            border-color: #fed7d7;
        }

        .conflict-list {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
        }

        .conflict-item {
            color: #721c24;
            margin-bottom: 5px;
        }

        h3 {
            color: #495057;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .schedule-grid {
                font-size: 10px;
                grid-template-columns: 60px repeat(31, 1fr);
            }
            
            .grid-cell {
                min-height: 30px;
                padding: 4px 2px;
            }
            
            .day-header {
                min-height: 40px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ æ€¥è¨ºæ’ç­ç³»çµ±</h1>
            <p>æ™ºèƒ½æ’ç­ â€¢ ç´„æŸç®¡ç† â€¢ å…¬å¹³åˆ†é…</p>
            <p style="font-size: 14px; margin-top: 8px; opacity: 0.9;">
                è¦å‰‡ï¼šé€£çºŒå·¥ä½œå¤©æ•¸=å¹³å‡å¤œç­æ•¸ â€¢ å¤œç­å¾Œä¸èƒ½æ¥ç™½ç­ â€¢ é å‡å‰ä¸€å¤©ä¸æ’å¤œç­ â€¢ æ¯æœˆæœ€å¾Œä¸€å¤©å¤œç­0äºº â€¢ ç›®æ¨™å¤œç­æ•¸å¹³å‡åˆ†é…
            </p>
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label>å¹´æœˆ</label>
                    <input type="month" id="monthSelect" value="2025-08">
                </div>
                <div class="control-group">
                    <label>å“¡å·¥äººæ•¸</label>
                    <input type="number" id="staffCount" min="8" max="12" value="10">
                </div>
                <div class="control-group">
                    <label>æ’ç­æ¨¡å¼</label>
                    <select id="scheduleMode">
                        <option value="continuous">é€£çºŒæ’ç­æ¨¡å¼</option>
                        <option value="balanced">å¹³è¡¡åˆ†æ•£æ¨¡å¼</option>
                    </select>
                </div>
                <button onclick="generateStaffList()">æ›´æ–°å“¡å·¥æ¸…å–®</button>
                <button onclick="generateSchedule()">ğŸ¯ è‡ªå‹•æ’ç­</button>
                <button onclick="exportSchedule()">ğŸ“‹ åŒ¯å‡ºæ’ç­è¡¨</button>
            </div>
        </div>

        <div class="staff-section">
            <div class="section-header" onclick="window.toggleSection('staff')">
                <h3>ğŸ‘¥ å“¡å·¥ç®¡ç†</h3>
                <span class="collapse-icon" id="staff-icon">â–¼</span>
            </div>
            <div class="section-content" id="staff-content">
                <div id="staffGrid" class="staff-grid"></div>
            </div>
        </div>

        <div class="requirements-section">
            <div class="section-header" onclick="window.toggleSection('requirements')">
                <h3>ğŸ“… æ¯æ—¥äººåŠ›éœ€æ±‚è¨­å®š</h3>
                <span class="collapse-icon" id="requirements-icon">â–¼</span>
            </div>
            <div class="section-content" id="requirements-content">
                <div class="stats-summary" id="requirementsSummary"></div>
                <div id="leaveAnalysis"></div>
                <div id="requirementsGrid" class="requirements-grid"></div>
            </div>
        </div>

        <div class="schedule-container">
            <h3>ğŸ“‹ æ’ç­è¡¨</h3>
            <div id="conflictList"></div>
            <div id="scheduleGrid" class="schedule-grid"></div>
            
            <div class="stats" id="stats"></div>
        </div>
    </div>

    <script>
        class EmergencyScheduler {
            constructor() {
                this.staff = [];
                this.schedule = {};
                this.requirements = {};
                this.currentMonth = '';
                this.daysInMonth = 0;
                this.conflicts = [];
            }

            init() {
                this.updateMonth();
                this.generateStaffList();
                this.generateRequirements();
                this.initializeEmptySchedule();
                this.renderAll();
            }

            updateMonth() {
                const monthInput = document.getElementById('monthSelect');
                this.currentMonth = monthInput.value;
                const date = new Date(this.currentMonth + '-01');
                this.daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            }

            // ç²å–æ˜ŸæœŸåç¨±
            getDayOfWeek(day) {
                const date = new Date(this.currentMonth + '-' + day.toString().padStart(2, '0'));
                const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                return dayNames[date.getDay()];
            }

            // åˆ¤æ–·æ˜¯å¦ç‚ºé€±æœ«
            isWeekend(day) {
                const date = new Date(this.currentMonth + '-' + day.toString().padStart(2, '0'));
                const dayOfWeek = date.getDay();
                return dayOfWeek === 0 || dayOfWeek === 6; // 0=é€±æ—¥, 6=é€±å…­
            }

            generateStaffList() {
                this.updateMonth();
                const count = parseInt(document.getElementById('staffCount').value);
                
                // ä¿ç•™ç¾æœ‰å“¡å·¥çš„å§“åå’Œè«‹å‡è³‡æ–™
                const existingStaff = {};
                this.staff.forEach(s => {
                    existingStaff[s.id] = {
                        name: s.name,
                        leaveRequests: s.leaveRequests || []
                    };
                });

                this.staff = [];
                const defaultNames = ['ç‹é†«å¸«', 'æé†«å¸«', 'å¼µé†«å¸«', 'é™³é†«å¸«', 'æ—é†«å¸«', 'é»ƒé†«å¸«', 
                              'å³é†«å¸«', 'åŠ‰é†«å¸«', 'è”¡é†«å¸«', 'è¨±é†«å¸«', 'é„­é†«å¸«', 'è¬é†«å¸«'];
                
                for (let i = 0; i < count; i++) {
                    // å¦‚æœä¹‹å‰å·²æœ‰é€™å€‹IDçš„å“¡å·¥ï¼Œä¿ç•™å…¶è³‡æ–™
                    if (existingStaff[i]) {
                        this.staff.push({
                            id: i,
                            name: existingStaff[i].name,
                            leaveRequests: existingStaff[i].leaveRequests
                        });
                    } else {
                        // æ–°å¢å“¡å·¥ä½¿ç”¨é è¨­åç¨±
                        const defaultName = defaultNames[i] || `é†«å¸«${i+1}`;
                        this.staff.push({
                            id: i,
                            name: defaultName,
                            leaveRequests: []
                        });
                    }
                }
                
                this.renderStaffGrid();
                this.generateRequirements();
            }

            generateRequirements() {
                this.requirements = {};
                for (let day = 1; day <= this.daysInMonth; day++) {
                    this.requirements[day] = {
                        dayShift: 2,
                        nightShift: day === this.daysInMonth ? 0 : 2
                    };
                }
                this.renderRequirements();
            }

            initializeEmptySchedule() {
                this.schedule = {};
                this.staff.forEach(staff => {
                    this.schedule[staff.id] = {};
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        this.schedule[staff.id][day] = {
                            dayShift: false,
                            nightShift: false,
                            leave: staff.leaveRequests.includes(day)
                        };
                    }
                });
            }

            renderStaffGrid() {
                const grid = document.getElementById('staffGrid');
                grid.innerHTML = '';
                
                this.staff.forEach(staff => {
                    const card = document.createElement('div');
                    card.className = 'staff-card';
                    card.innerHTML = `
                        <div class="staff-header">
                            <div class="control-group" style="margin-bottom: 10px;">
                                <label>å“¡å·¥å§“å</label>
                                <input type="text" 
                                       value="${staff.name}"
                                       onchange="scheduler.updateStaffName(${staff.id}, this.value)"
                                       placeholder="è«‹è¼¸å…¥å“¡å·¥å§“å"
                                       style="font-weight: 600; background: #fff; border: 2px solid #dee2e6;">
                            </div>
                        </div>
                        <div class="control-group">
                            <label>è«‹å‡æ—¥æœŸ (ä»¥é€—è™Ÿåˆ†éš”ï¼Œå¦‚: 5,12,20)</label>
                            <input type="text" 
                                   value="${staff.leaveRequests.join(',')}"
                                   onchange="scheduler.updateLeave(${staff.id}, this.value)"
                                   placeholder="è«‹è¼¸å…¥è«‹å‡æ—¥æœŸ">
                        </div>
                        <div class="leave-dates">
                            ${staff.leaveRequests.map(date => 
                                `<span class="leave-tag">${date}æ—¥</span>`
                            ).join('')}
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }

            renderRequirements() {
                this.renderRequirementsSummary();
                this.renderLeaveAnalysis();
                this.renderRequirementsGrid();
            }

            renderRequirementsSummary() {
                const summary = document.getElementById('requirementsSummary');
                
                let totalDayShifts = 0;
                let totalNightShifts = 0;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    totalDayShifts += this.requirements[day].dayShift;
                    totalNightShifts += this.requirements[day].nightShift;
                }
                
                const avgDayShifts = (totalDayShifts / this.staff.length).toFixed(1);
                const avgNightShifts = (totalNightShifts / this.staff.length).toFixed(1);
                
                summary.innerHTML = `
                    <div class="summary-card">
                        <div class="summary-value">${totalDayShifts}</div>
                        <div class="summary-label">ç¸½ç™½ç­éœ€æ±‚</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${totalNightShifts}</div>
                        <div class="summary-label">ç¸½å¤œç­éœ€æ±‚</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${avgDayShifts}</div>
                        <div class="summary-label">å¹³å‡ç™½ç­/äºº</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${avgNightShifts}</div>
                        <div class="summary-label">å¹³å‡å¤œç­/äºº</div>
                    </div>
                `;
            }

            renderLeaveAnalysis() {
                const analysis = document.getElementById('leaveAnalysis');
                
                // è¨ˆç®—æ¯å¤©çš„è«‹å‡äººæ•¸
                const leaveCounts = {};
                for (let day = 1; day <= this.daysInMonth; day++) {
                    leaveCounts[day] = 0;
                }
                
                this.staff.forEach(staff => {
                    staff.leaveRequests.forEach(day => {
                        if (day >= 1 && day <= this.daysInMonth) {
                            leaveCounts[day]++;
                        }
                    });
                });
                
                // æ‰¾å‡ºè«‹å‡äººæ•¸è¼ƒå¤šçš„æ—¥æœŸ
                const highLeaveDays = [];
                const mediumLeaveDays = [];
                const lowLeaveDays = [];
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const count = leaveCounts[day];
                    const dayName = this.getDayOfWeek(day);
                    const dayInfo = `${day}æ—¥(${dayName})`;
                    
                    if (count >= 3) {
                        highLeaveDays.push({ day: dayInfo, count });
                    } else if (count === 2) {
                        mediumLeaveDays.push({ day: dayInfo, count });
                    } else if (count === 1) {
                        lowLeaveDays.push({ day: dayInfo, count });
                    }
                }
                
                if (highLeaveDays.length === 0 && mediumLeaveDays.length === 0 && lowLeaveDays.length === 0) {
                    analysis.innerHTML = `
                        <div class="leave-analysis">
                            <h4>ğŸ“Š è«‹å‡åˆ†æ</h4>
                            <p style="color: #28a745; margin: 0;">ç›®å‰æ²’æœ‰å“¡å·¥è«‹å‡ï¼ŒäººåŠ›å……è¶³ï¼</p>
                        </div>
                    `;
                    return;
                }
                
                analysis.innerHTML = `
                    <div class="leave-analysis">
                        <h4>ğŸ“Š è«‹å‡åˆ†æ - å»ºè­°èª¿æ•´äººåŠ›éœ€æ±‚</h4>
                        <div class="high-leave-days">
                            ${highLeaveDays.map(item => 
                                `<span class="leave-day-tag">${item.day}: ${item.count}äººè«‹å‡</span>`
                            ).join('')}
                            ${mediumLeaveDays.map(item => 
                                `<span class="leave-day-tag medium">${item.day}: ${item.count}äººè«‹å‡</span>`
                            ).join('')}
                            ${lowLeaveDays.map(item => 
                                `<span class="leave-day-tag low">${item.day}: ${item.count}äººè«‹å‡</span>`
                            ).join('')}
                        </div>
                        ${highLeaveDays.length > 0 ? 
                            `<p style="margin-top: 10px; color: #856404; font-size: 14px;">
                                âš ï¸ ç´…è‰²æ¨™è¨˜çš„æ—¥æœŸè«‹å‡äººæ•¸è¼ƒå¤šï¼Œå»ºè­°é©ç•¶é™ä½ç•¶å¤©çš„äººåŠ›éœ€æ±‚ä»¥æé«˜æ’ç­æˆåŠŸç‡
                            </p>` : ''
                        }
                    </div>
                `;
            }

            renderRequirementsGrid() {
                const grid = document.getElementById('requirementsGrid');
                grid.innerHTML = '';
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const card = document.createElement('div');
                    const isWeekendDay = this.isWeekend(day);
                    const dayName = this.getDayOfWeek(day);
                    
                    // è¨ˆç®—ç•¶å¤©è«‹å‡äººæ•¸
                    const leaveCount = this.staff.filter(staff => 
                        staff.leaveRequests.includes(day)
                    ).length;
                    
                    card.className = `day-requirement ${isWeekendDay ? 'weekend' : ''}`;
                    card.innerHTML = `
                        <strong>${day}æ—¥ (${dayName})</strong>
                        ${leaveCount > 0 ? `<div style="color: #dc3545; font-size: 11px; margin: 2px 0;">${leaveCount}äººè«‹å‡</div>` : ''}
                        <div style="margin: 8px 0;">
                            <label>ç™½ç­</label>
                            <input type="number" min="1" max="3" 
                                   value="${this.requirements[day].dayShift}"
                                   onchange="scheduler.updateRequirement(${day}, 'dayShift', this.value)"
                                   style="width: 50px; margin-left: 5px;">
                        </div>
                        <div>
                            <label>å¤œç­</label>
                            <input type="number" min="0" max="3" 
                                   value="${this.requirements[day].nightShift}"
                                   onchange="scheduler.updateRequirement(${day}, 'nightShift', this.value)"
                                   style="width: 50px; margin-left: 5px;"
                                   ${day === this.daysInMonth ? 'disabled' : ''}>
                        </div>
                    `;
                    grid.appendChild(card);
                }
            }

            updateLeave(staffId, leaveStr) {
                const leaves = leaveStr.split(',')
                    .map(s => parseInt(s.trim()))
                    .filter(n => !isNaN(n) && n >= 1 && n <= this.daysInMonth);
                
                this.staff[staffId].leaveRequests = leaves;
                this.renderStaffGrid();
                
                // é‡æ–°æ¸²æŸ“è«‹å‡åˆ†æå’Œéœ€æ±‚ç¶²æ ¼
                this.renderLeaveAnalysis();
                this.renderRequirementsGrid();
                
                // å¦‚æœå·²ç¶“æœ‰æ’ç­è¡¨ï¼Œéœ€è¦æ›´æ–°æ’ç­è¡¨ä¸­çš„è«‹å‡ç‹€æ…‹
                if (this.schedule && Object.keys(this.schedule).length > 0) {
                    this.initializeEmptySchedule();
                    this.renderSchedule();
                }
            }

            updateStaffName(staffId, newName) {
                if (newName && newName.trim()) {
                    this.staff[staffId].name = newName.trim();
                    
                    // å¦‚æœå·²ç¶“æœ‰æ’ç­è¡¨ï¼Œéœ€è¦é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºæ–°åå­—
                    if (this.schedule && Object.keys(this.schedule).length > 0) {
                        this.renderSchedule();
                        this.renderStats();
                    }
                }
            }

            updateRequirement(day, shift, value) {
                this.requirements[day][shift] = parseInt(value);
                // æ›´æ–°éœ€æ±‚å¾Œé‡æ–°æ¸²æŸ“çµ±è¨ˆ
                this.renderRequirementsSummary();
            }

            generateSchedule() {
                console.log('=== é–‹å§‹å®Œæ•´æ’ç­æµç¨‹ ===');
                
                // æ¸…ç©ºä¹‹å‰çš„æ’ç­çµæœ
                this.schedule = {};
                this.conflicts = [];
                
                // åˆå§‹åŒ–æ’ç­è¡¨
                this.staff.forEach(staff => {
                    this.schedule[staff.id] = {};
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        this.schedule[staff.id][day] = {
                            dayShift: false,
                            nightShift: false,
                            leave: staff.leaveRequests.includes(day)
                        };
                    }
                });

                // 1. å…ˆæ’å¤œç­
                const nightShiftSuccess = this.scheduleNightShifts();
                
                if (!nightShiftSuccess) {
                    console.log('âŒ å¤œç­æ’ç­å¤±æ•—ï¼Œç„¡æ³•ç”¢ç”Ÿæœ‰æ•ˆæ’ç­è¡¨');
                    this.renderAll();
                    return;
                }

                console.log('âœ… å¤œç­æ’ç­å®Œæˆï¼Œé–‹å§‹æ’ç™½ç­');
                
                // 2. å†æ’ç™½ç­
                const dayShiftSuccess = this.scheduleDayShifts();
                
                if (!dayShiftSuccess) {
                    console.log('âŒ ç™½ç­æ’ç­å¤±æ•—ï¼Œä½†å¤œç­å·²å®Œæˆ');
                } else {
                    console.log('âœ… ç™½ç­æ’ç­å®Œæˆ');
                }
                
                this.renderAll();
            }

            scheduleNightShifts() {
                console.log('=== é–‹å§‹å¤œç­æ’ç­ ===');
                
                let maxAttempts = 1000;
                let bestSchedule = null;
                let bestBalance = Infinity;
                let perfectBalanceCount = 0;
                
                // è¨ˆç®—ç¸½å¤œç­éœ€æ±‚
                const totalNightShiftsNeeded = Object.values(this.requirements)
                    .reduce((sum, req) => sum + req.nightShift, 0);
                const targetNightShiftsPerPerson = Math.floor(totalNightShiftsNeeded / this.staff.length);
                
                console.log(`ç¸½å¤œç­éœ€æ±‚: ${totalNightShiftsNeeded}ç­`);
                console.log(`ç›®æ¨™æ¯äººå¤œç­æ•¸: ${targetNightShiftsPerPerson}ç­`);
                console.log(`é–‹å§‹é€²è¡Œæœ€å¤š${maxAttempts}æ¬¡å¤œç­æ’ç­å˜—è©¦ï¼Œç›®æ¨™ï¼šæ¯å€‹äºº${targetNightShiftsPerPerson}ç­`);
                
                for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                    this.clearNightShifts();
                    
                    // é‡ç½®å¤œç­è¨ˆæ•¸
                    this.staff.forEach(staff => {
                        staff.currentNightShifts = 0;
                    });
                    
                    // é€æ—¥å®‰æ’å¤œç­
                    for (let day = 1; day <= this.daysInMonth - 1; day++) {
                        const needed = this.requirements[day].nightShift;
                        if (needed === 0) continue;
                        
                        const selectedStaff = this.selectStaffForNightShift(day, needed, targetNightShiftsPerPerson);
                        
                        selectedStaff.forEach(staff => {
                            this.schedule[staff.id][day].nightShift = true;
                            staff.currentNightShifts++;
                        });
                    }
                    
                    const balance = this.calculateNightShiftBalance();
                    
                    if (attempt % 50 === 0 || balance === 0) {
                        console.log(`ç¬¬${attempt}æ¬¡å¤œç­å˜—è©¦ - æœ€å¤§å·®è·: ${balance}ç­`);
                    }
                    
                    if (balance < bestBalance) {
                        bestBalance = balance;
                        bestSchedule = this.copyCurrentSchedule();
                        console.log(`ğŸ¯ ç™¼ç¾æ›´ä½³å¤œç­æ–¹æ¡ˆï¼æœ€å¤§å·®è·: ${balance}ç­ (ç¬¬${attempt}æ¬¡å˜—è©¦)`);
                    }
                    
                    if (balance === 0) {
                        perfectBalanceCount++;
                        if (perfectBalanceCount >= 3) {
                            console.log(`ğŸ‰ é€£çºŒæ‰¾åˆ°${perfectBalanceCount}æ¬¡å®Œå…¨å¹³è¡¡å¤œç­æ–¹æ¡ˆï¼æ¯äºº${targetNightShiftsPerPerson}ç­`);
                            break;
                        }
                    }
                    
                    if (bestBalance <= 1 && attempt >= 200) {
                        console.log(`âœ… å·²æ‰¾åˆ°å·®è·${bestBalance}ç­çš„è‰¯å¥½å¤œç­æ–¹æ¡ˆ`);
                        break;
                    }
                }
                
                if (bestSchedule && bestBalance === 0) {
                    this.restoreSchedule(bestSchedule);
                    console.log(`ğŸ† æ¡ç”¨å®Œå…¨å¹³è¡¡å¤œç­æ–¹æ¡ˆ - å·®è·: ${bestBalance}ç­ï¼Œæ¯äºº${targetNightShiftsPerPerson}ç­`);
                    return true;
                } else {
                    console.log('âŒ æœªæ‰¾åˆ°å®Œå…¨å¹³è¡¡å¤œç­æ–¹æ¡ˆ');
                    return false;
                }
            }

            scheduleDayShifts() {
                console.log('=== é–‹å§‹ç™½ç­æ’ç­ ===');
                
                let maxAttempts = 1000;
                let bestSchedule = null;
                let bestBalance = Infinity;
                let bestFulfillment = 0;
                let bestAverageCount = 0;
                
                // è¨ˆç®—ç¸½ç™½ç­æ•¸å’Œå¹³å‡å€¼
                const totalDayShiftsNeeded = Object.values(this.requirements)
                    .reduce((sum, req) => sum + req.dayShift, 0);
                const averageDayShifts = Math.round(totalDayShiftsNeeded / this.staff.length);
                const targetPeopleCount = this.staff.length - 3; // N-3å€‹äººé”åˆ°å¹³å‡
                
                console.log(`é–‹å§‹é€²è¡Œæœ€å¤š${maxAttempts}æ¬¡ç™½ç­æ’ç­å˜—è©¦`);
                console.log(`ç›®æ¨™ï¼š${targetPeopleCount}äººé”åˆ°å¹³å‡${averageDayShifts}ç­å³ç‚ºæœ€ä½³è§£`);
                
                for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                    // åªæ¸…ç©ºç™½ç­ï¼Œä¿ç•™å¤œç­
                    this.clearDayShifts();
                    
                    // é‡ç½®ç™½ç­è¨ˆæ•¸
                    this.staff.forEach(staff => {
                        staff.currentDayShifts = 0;
                    });
                    
                    // ä½¿ç”¨å¹³è¡¡å„ªå…ˆçš„æ’ç­ç­–ç•¥
                    this.assignDayShiftsBalanced();
                    
                    const balance = this.calculateDayShiftBalance();
                    const fulfillment = this.calculateDayShiftFulfillment();
                    const averageAchievers = this.countPeopleAtAverageDayShifts(averageDayShifts);
                    
                    if (attempt % 50 === 0 || averageAchievers >= targetPeopleCount || attempt <= 3) {
                        console.log(`ç¬¬${attempt}æ¬¡ç™½ç­å˜—è©¦ - å·®è·: ${balance}ç­, æ»¿è¶³: ${fulfillment.toFixed(1)}%, é”å¹³å‡äººæ•¸: ${averageAchievers}/${this.staff.length}`);
                    }
                    
                    // å„ªå…ˆè€ƒæ…®é”åˆ°å¹³å‡çš„äººæ•¸ï¼Œå…¶æ¬¡è€ƒæ…®å¹³è¡¡æ€§ï¼Œæœ€å¾Œè€ƒæ…®éœ€æ±‚æ»¿è¶³åº¦
                    const isBetter = averageAchievers > bestAverageCount || 
                                   (averageAchievers === bestAverageCount && balance < bestBalance) ||
                                   (averageAchievers === bestAverageCount && balance === bestBalance && fulfillment > bestFulfillment);
                    
                    if (isBetter) {
                        bestBalance = balance;
                        bestFulfillment = fulfillment;
                        bestAverageCount = averageAchievers;
                        bestSchedule = this.copyCurrentDaySchedule();
                        if (attempt <= 10 || averageAchievers >= targetPeopleCount) {
                            console.log(`ğŸ¯ ç™¼ç¾æ›´ä½³ç™½ç­æ–¹æ¡ˆï¼é”å¹³å‡: ${averageAchievers}äºº, å·®è·: ${balance}ç­, æ»¿è¶³: ${fulfillment.toFixed(1)}%`);
                        }
                    }
                    
                    // å¦‚æœé”åˆ°ç›®æ¨™äººæ•¸ï¼Œæå‰çµæŸ
                    if (averageAchievers >= targetPeopleCount) {
                        console.log(`ğŸ‰ é”æˆç›®æ¨™ï¼${averageAchievers}äººé”åˆ°å¹³å‡${averageDayShifts}ç­`);
                        break;
                    }
                    
                    // å¦‚æœæ‰¾åˆ°äº†å¾ˆå¥½çš„æ–¹æ¡ˆä¸”å˜—è©¦è¶…é500æ¬¡ï¼Œä¹Ÿå¯ä»¥è€ƒæ…®æå‰çµæŸ
                    if (averageAchievers >= targetPeopleCount - 1 && balance <= 2 && attempt >= 500) {
                        console.log(`âœ… æ‰¾åˆ°æ¥è¿‘ç›®æ¨™çš„æ–¹æ¡ˆ - é”å¹³å‡: ${averageAchievers}äºº, å·®è·: ${balance}ç­`);
                        break;
                    }
                }
                
                if (bestSchedule) {
                    this.restoreDaySchedule(bestSchedule);
                    console.log(`ğŸ† æ¡ç”¨æœ€ä½³ç™½ç­æ–¹æ¡ˆ - é”å¹³å‡: ${bestAverageCount}äºº, å·®è·: ${bestBalance}ç­, æ»¿è¶³: ${bestFulfillment.toFixed(1)}%`);
                    this.reportDayShiftDistribution(averageDayShifts);
                    this.checkConflicts();
                    this.renderStats();
                    return true;
                } else {
                    console.log('âŒ æœªæ‰¾åˆ°å¯è¡Œç™½ç­æ–¹æ¡ˆ');
                    return false;
                }
            }

            assignDayShiftsBalanced() {
                // è¨ˆç®—ç›®æ¨™å¤œç­æ•¸ï¼Œç”¨æ–¼æ±ºå®šé€£çºŒå·¥ä½œå¤©æ•¸é™åˆ¶
                const totalNightShiftsNeeded = Object.values(this.requirements)
                    .reduce((sum, req) => sum + req.nightShift, 0);
                const targetNightShifts = Math.floor(totalNightShiftsNeeded / this.staff.length);
                const maxConsecutiveDays = targetNightShifts; // æ ¹æ“šå¤œç­å¹³å‡æ•¸è¨­å®šé€£çºŒå·¥ä½œé™åˆ¶
                
                console.log(`ç™½ç­æ’ç­ - ç›®æ¨™å¤œç­æ•¸: ${targetNightShifts}ç­ï¼Œé€£çºŒå·¥ä½œé™åˆ¶: ${maxConsecutiveDays}å¤©`);
                
                // é€æ—¥å®‰æ’ç™½ç­ï¼Œä½¿ç”¨å¹³è¡¡ç­–ç•¥
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const needed = this.requirements[day].dayShift;
                    if (needed === 0) continue;
                    
                    // ç²å–å¯å·¥ä½œäººå“¡ä¸¦æŒ‰ç™½ç­æ•¸æ’åºï¼ˆå°‘çš„å„ªå…ˆï¼‰
                    const availableStaff = this.getAvailableStaffForDay(day, maxConsecutiveDays);
                    
                    if (availableStaff.length === 0) {
                        continue; // æ²’æœ‰å¯ç”¨äººå“¡
                    }
                    
                    // æŒ‰ç•¶å‰ç™½ç­æ•¸æ’åºï¼Œç­æ•¸å°‘çš„å„ªå…ˆ
                    availableStaff.sort((a, b) => {
                        const aDayShifts = a.currentDayShifts || 0;
                        const bDayShifts = b.currentDayShifts || 0;
                        if (aDayShifts !== bDayShifts) {
                            return aDayShifts - bDayShifts; // ç­æ•¸å°‘çš„å„ªå…ˆ
                        }
                        // å¦‚æœç­æ•¸ç›¸åŒï¼Œéš¨æ©Ÿæ’åº
                        return Math.random() - 0.5;
                    });
                    
                    // é¸æ“‡å‰Nå
                    const selectedCount = Math.min(needed, availableStaff.length);
                    const selectedStaff = availableStaff.slice(0, selectedCount);
                    
                    // åˆ†é…ç™½ç­
                    selectedStaff.forEach(staff => {
                        this.schedule[staff.id][day].dayShift = true;
                        staff.currentDayShifts = (staff.currentDayShifts || 0) + 1;
                    });
                }
            }

            getAvailableStaffForDay(day, maxConsecutiveDays = 6) {
                const availableStaff = [];
                
                this.staff.forEach(staff => {
                    // æª¢æŸ¥åŸºæœ¬å¯å·¥ä½œæ¢ä»¶
                    const isOnLeave = this.schedule[staff.id][day].leave;
                    const alreadyDayShift = this.schedule[staff.id][day].dayShift;
                    const hasNightToday = this.schedule[staff.id][day].nightShift;
                    const hadNightYesterday = day > 1 && this.schedule[staff.id][day-1].nightShift;
                    
                    // çµ•å°ä¸èƒ½é•åçš„æ¢ä»¶
                    if (isOnLeave) return;           // è«‹å‡
                    if (alreadyDayShift) return;     // å·²æœ‰ç™½ç­
                    if (hasNightToday) return;       // ç•¶å¤©å¤œç­
                    if (hadNightYesterday) return;   // å‰ä¸€æ—¥å¤œç­
                    
                    // æª¢æŸ¥é€£çºŒå·¥ä½œå¤©æ•¸ï¼ˆå‹•æ…‹é™åˆ¶ï¼‰
                    const consecutiveDays = this.getConsecutiveDays(staff.id, day);
                    if (consecutiveDays >= maxConsecutiveDays) return;
                    
                    // é€šéæª¢æŸ¥çš„äººå“¡
                    availableStaff.push(staff);
                });
                
                return availableStaff;
            }

            countPeopleAtAverageDayShifts(averageDayShifts) {
                return this.staff.filter(staff => 
                    (staff.currentDayShifts || 0) === averageDayShifts
                ).length;
            }

            reportDayShiftDistribution(averageDayShifts) {
                console.log('\n=== ç™½ç­åˆ†é…çµæœ ===');
                
                // æŒ‰ç­æ•¸åˆ†çµ„é¡¯ç¤º
                const countGroups = {};
                this.staff.forEach(staff => {
                    const count = staff.currentDayShifts || 0;
                    if (!countGroups[count]) countGroups[count] = [];
                    countGroups[count].push(staff.name);
                });
                
                const dayCounts = this.staff.map(staff => staff.currentDayShifts || 0);
                const minDays = Math.min(...dayCounts);
                const maxDays = Math.max(...dayCounts);
                const totalDays = dayCounts.reduce((sum, count) => sum + count, 0);
                const avgDays = totalDays / this.staff.length;
                
                console.log(`ç¸½ç™½ç­æ•¸: ${totalDays}ç­`);
                console.log(`å¹³å‡ç­æ•¸: ${avgDays.toFixed(1)}ç­`);
                console.log(`ç­æ•¸ç¯„åœ: ${minDays} - ${maxDays}ç­`);
                console.log(`æœ€å¤§å·®è·: ${maxDays - minDays}ç­`);
                
                console.log('\nç­æ•¸åˆ†å¸ƒ:');
                for (let count = minDays; count <= maxDays; count++) {
                    if (countGroups[count]) {
                        const isAverage = count === averageDayShifts;
                        const marker = isAverage ? 'â­' : '  ';
                        console.log(`${marker}${count}ç­: ${countGroups[count].join(', ')} (${countGroups[count].length}äºº)`);
                    }
                }
                
                const averageAchievers = this.countPeopleAtAverageDayShifts(averageDayShifts);
                const targetPeopleCount = this.staff.length - 3;
                
                console.log(`\nâ­ é”åˆ°å¹³å‡${averageDayShifts}ç­çš„äººæ•¸: ${averageAchievers}/${this.staff.length}`);
                console.log(`ğŸ¯ ç›®æ¨™äººæ•¸: ${targetPeopleCount}äºº`);
                
                if (averageAchievers >= targetPeopleCount) {
                    console.log('ğŸ‰ é”æˆç›®æ¨™ï¼å¤§éƒ¨åˆ†äººéƒ½é”åˆ°å¹³å‡ç­æ•¸');
                } else if (averageAchievers >= targetPeopleCount - 1) {
                    console.log('ğŸŒŸ æ¥è¿‘ç›®æ¨™ï¼åˆ†é…ç›¸ç•¶å‡å‹»');
                } else {
                    console.log('âš ï¸ æœªé”ç›®æ¨™ï¼Œä½†å·²æ˜¯ç•¶å‰æœ€ä½³æ–¹æ¡ˆ');
                }
            }

            selectStaffForNightShift(day, needed, targetNightShifts = 5) {
                const groups = this.groupStaffByNightPriority(day, targetNightShifts);
                
                const selectedStaff = [];
                
                // å„ªå…ˆå¾é«˜å„ªå…ˆç´šé¸æ“‡
                if (groups.high.length > 0) {
                    const highPicks = Math.min(needed, groups.high.length);
                    const shuffled = this.shuffleArray([...groups.high]);
                    selectedStaff.push(...shuffled.slice(0, highPicks));
                }
                
                // å¦‚æœé‚„éœ€è¦äººï¼Œå¾ä¸­å„ªå…ˆç´šé¸æ“‡
                if (selectedStaff.length < needed && groups.medium.length > 0) {
                    const mediumNeeded = needed - selectedStaff.length;
                    const mediumPicks = Math.min(mediumNeeded, groups.medium.length);
                    const shuffled = this.shuffleArray([...groups.medium]);
                    selectedStaff.push(...shuffled.slice(0, mediumPicks));
                }
                
                // æœ€å¾Œå¾ä½å„ªå…ˆç´šé¸æ“‡
                if (selectedStaff.length < needed && groups.low.length > 0) {
                    const lowNeeded = needed - selectedStaff.length;
                    const lowPicks = Math.min(lowNeeded, groups.low.length);
                    const shuffled = this.shuffleArray([...groups.low]);
                    selectedStaff.push(...shuffled.slice(0, lowPicks));
                }
                
                return selectedStaff;
            }

            groupStaffByNightPriority(day, targetNightShifts = 5) {
                const groups = { high: [], medium: [], low: [] };
                
                this.staff.forEach(staff => {
                    if (!this.canWorkNightShift(staff.id, day)) {
                        return;
                    }
                    
                    const nightShifts = staff.currentNightShifts;
                    const hadNightYesterday = day > 1 && this.schedule[staff.id][day-1].nightShift;
                    
                    // é«˜å„ªå…ˆç´šï¼šå¤œç­æ•¸å°‘æ–¼ç›®æ¨™ä¸”å‰ä¸€å¤©ä¹Ÿæ˜¯å¤œç­ï¼ˆé€£çºŒå¤œç­ï¼‰
                    if (nightShifts < targetNightShifts && hadNightYesterday) {
                        groups.high.push(staff);
                    }
                    // ä¸­å„ªå…ˆç´šï¼šå¤œç­æ•¸å°‘æ–¼ç›®æ¨™
                    else if (nightShifts < targetNightShifts) {
                        groups.medium.push(staff);
                    }
                    // ä½å„ªå…ˆç´šï¼šå·²é”åˆ°æˆ–è¶…éç›®æ¨™å¤œç­æ•¸
                    else {
                        groups.low.push(staff);
                    }
                });
                
                return groups;
            }

            canWorkNightShift(staffId, day) {
                if (this.schedule[staffId][day].leave) return false;
                if (this.schedule[staffId][day].nightShift) return false;
                if (day === this.daysInMonth) return false;
                
                const staff = this.staff.find(s => s.id === staffId);
                if (staff && staff.leaveRequests.includes(day + 1)) return false;
                
                return true;
            }

            canWorkDayShift(staffId, day) {
                if (this.schedule[staffId][day].leave) return false;
                if (this.schedule[staffId][day].dayShift) return false;
                
                // å¤œç­å¾Œä¸èƒ½æ¥ç™½ç­ï¼ˆè‡³å°‘é–“éš”12å°æ™‚ï¼‰
                if (day > 1 && this.schedule[staffId][day-1].nightShift) return false;
                
                // å‹•æ…‹è¨ˆç®—é€£çºŒå·¥ä½œå¤©æ•¸é™åˆ¶
                const totalNightShiftsNeeded = Object.values(this.requirements)
                    .reduce((sum, req) => sum + req.nightShift, 0);
                const targetNightShifts = Math.floor(totalNightShiftsNeeded / this.staff.length);
                const maxConsecutiveDays = targetNightShifts; // æ ¹æ“šå¤œç­å¹³å‡æ•¸è¨­å®š
                
                // æª¢æŸ¥é€£çºŒå·¥ä½œå¤©æ•¸
                const consecutiveDays = this.getConsecutiveDays(staffId, day);
                if (consecutiveDays >= maxConsecutiveDays) return false;
                
                return true;
            }

            getConsecutiveDays(staffId, currentDay) {
                let consecutiveDays = 0;
                
                // å¾€å‰æŸ¥çœ‹é€£çºŒå·¥ä½œå¤©æ•¸
                for (let day = currentDay - 1; day >= 1; day--) {
                    const hasWork = this.schedule[staffId][day].dayShift || this.schedule[staffId][day].nightShift;
                    if (hasWork) {
                        consecutiveDays++;
                    } else {
                        break;
                    }
                }
                
                return consecutiveDays;
            }

            clearNightShifts() {
                this.staff.forEach(staff => {
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        if (this.schedule[staff.id] && this.schedule[staff.id][day]) {
                            this.schedule[staff.id][day].nightShift = false;
                        }
                    }
                });
            }

            clearDayShifts() {
                this.staff.forEach(staff => {
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        if (this.schedule[staff.id] && this.schedule[staff.id][day]) {
                            this.schedule[staff.id][day].dayShift = false;
                        }
                    }
                });
            }

            calculateNightShiftBalance() {
                const nightCounts = this.staff.map(staff => staff.currentNightShifts);
                const maxNights = Math.max(...nightCounts);
                const minNights = Math.min(...nightCounts);
                return maxNights - minNights;
            }

            calculateDayShiftBalance() {
                const dayCounts = this.staff.map(staff => staff.currentDayShifts || 0);
                const maxDays = Math.max(...dayCounts);
                const minDays = Math.min(...dayCounts);
                return maxDays - minDays;
            }

            calculateDayShiftFulfillment() {
                let totalRequired = 0;
                let totalAssigned = 0;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const required = this.requirements[day].dayShift;
                    const assigned = this.staff.filter(staff => 
                        this.schedule[staff.id][day].dayShift).length;
                    
                    totalRequired += required;
                    totalAssigned += assigned;
                }
                
                return totalRequired > 0 ? (totalAssigned / totalRequired) * 100 : 100;
            }

            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            copyCurrentSchedule() {
                const copy = {};
                this.staff.forEach(staff => {
                    copy[staff.id] = {};
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        copy[staff.id][day] = {
                            ...this.schedule[staff.id][day]
                        };
                    }
                });
                
                const staffCounts = {};
                this.staff.forEach(staff => {
                    staffCounts[staff.id] = {
                        nightShifts: staff.currentNightShifts,
                        dayShifts: staff.currentDayShifts || 0
                    };
                });
                
                return { schedule: copy, counts: staffCounts };
            }

            copyCurrentDaySchedule() {
                const copy = {};
                this.staff.forEach(staff => {
                    copy[staff.id] = {};
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        copy[staff.id][day] = {
                            dayShift: this.schedule[staff.id][day].dayShift,
                            nightShift: this.schedule[staff.id][day].nightShift,
                            leave: this.schedule[staff.id][day].leave
                        };
                    }
                });
                
                const staffCounts = {};
                this.staff.forEach(staff => {
                    staffCounts[staff.id] = staff.currentDayShifts || 0;
                });
                
                return { schedule: copy, counts: staffCounts };
            }

            restoreSchedule(saved) {
                this.schedule = saved.schedule;
                
                this.staff.forEach(staff => {
                    staff.currentNightShifts = saved.counts[staff.id].nightShifts;
                    staff.currentDayShifts = saved.counts[staff.id].dayShifts;
                });
            }

            restoreDaySchedule(saved) {
                // åªæ¢å¾©ç™½ç­éƒ¨åˆ†ï¼Œä¿ç•™å¤œç­
                this.staff.forEach(staff => {
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        this.schedule[staff.id][day].dayShift = saved.schedule[staff.id][day].dayShift;
                    }
                    staff.currentDayShifts = saved.counts[staff.id];
                });
            }

            checkConflicts() {
                this.conflicts = [];
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const dayShiftCount = this.staff.filter(staff => 
                        this.schedule[staff.id][day].dayShift).length;
                    const nightShiftCount = this.staff.filter(staff => 
                        this.schedule[staff.id][day].nightShift).length;
                    
                    if (dayShiftCount < this.requirements[day].dayShift) {
                        this.conflicts.push({
                            type: 'understaffed',
                            day: day,
                            shift: 'day',
                            needed: this.requirements[day].dayShift,
                            actual: dayShiftCount
                        });
                    }
                    
                    if (nightShiftCount < this.requirements[day].nightShift) {
                        this.conflicts.push({
                            type: 'understaffed',
                            day: day,
                            shift: 'night',
                            needed: this.requirements[day].nightShift,
                            actual: nightShiftCount
                        });
                    }
                    
                    // æª¢æŸ¥é•åè¦å‰‡çš„æƒ…æ³
                    this.staff.forEach(staff => {
                        const schedule = this.schedule[staff.id][day];
                        
                        // æª¢æŸ¥å¤œç­å¾Œæ¥ç™½ç­
                        if (day > 1 && this.schedule[staff.id][day-1].nightShift && schedule.dayShift) {
                            this.conflicts.push({
                                type: 'rule_violation',
                                day: day,
                                staff: staff.name,
                                rule: 'å¤œç­å¾Œä¸èƒ½æ¥ç™½ç­'
                            });
                        }
                        
                        // æª¢æŸ¥åŒä¸€å¤©æ—¥å¤œç­
                        if (schedule.dayShift && schedule.nightShift) {
                            this.conflicts.push({
                                type: 'rule_violation',
                                day: day,
                                staff: staff.name,
                                rule: 'åŒä¸€å¤©ä¸èƒ½æ—¢ä¸Šæ—¥ç­åˆä¸Šå¤œç­'
                            });
                        }
                    });
                }
                
                this.renderConflicts();
            }

            renderConflicts() {
                const conflictList = document.getElementById('conflictList');
                
                if (this.conflicts.length === 0) {
                    conflictList.innerHTML = '';
                    return;
                }
                
                conflictList.innerHTML = `
                    <div class="conflict-list">
                        <h4>âš ï¸ æ’ç­å•é¡Œ</h4>
                        ${this.conflicts.map(conflict => {
                            if (conflict.type === 'understaffed') {
                                const shiftName = conflict.shift === 'day' ? 'ç™½ç­' : 'å¤œç­';
                                return `<div class="conflict-item">
                                    ${conflict.day}æ—¥ ${shiftName} äººåŠ›ä¸è¶³ï¼šéœ€è¦${conflict.needed}äººï¼Œå¯¦éš›${conflict.actual}äºº
                                </div>`;
                            } else if (conflict.type === 'rule_violation') {
                                return `<div class="conflict-item">
                                    ${conflict.day}æ—¥ ${conflict.staff} é•åè¦å‰‡ï¼š${conflict.rule}
                                </div>`;
                            }
                            return '';
                        }).join('')}
                    </div>
                `;
            }

            renderSchedule() {
                const grid = document.getElementById('scheduleGrid');
                grid.innerHTML = '';
                
                if (!this.schedule || Object.keys(this.schedule).length === 0) {
                    grid.innerHTML = '<div class="grid-cell">è«‹å…ˆé»æ“Šã€Œè‡ªå‹•æ’ç­ã€ç”Ÿæˆæ’ç­è¡¨</div>';
                    return;
                }
                
                // å‹•æ…‹è¨­å®šç¶²æ ¼åˆ—æ•¸ï¼š1åˆ—å“¡å·¥åç¨± + Nåˆ—æ—¥æœŸ
                grid.style.gridTemplateColumns = `80px repeat(${this.daysInMonth}, 1fr)`;
                
                // è¡¨é ­
                grid.appendChild(this.createCell('', 'grid-header'));
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const dayName = this.getDayOfWeek(day);
                    const isWeekendDay = this.isWeekend(day);
                    const headerClass = `day-header ${isWeekendDay ? 'weekend' : ''}`;
                    
                    const cell = document.createElement('div');
                    cell.className = headerClass;
                    cell.innerHTML = `
                        <div class="day-number">${day}</div>
                        <div class="day-name">${dayName}</div>
                    `;
                    grid.appendChild(cell);
                }
                
                // å“¡å·¥æ’ç­
                this.staff.forEach(staff => {
                    grid.appendChild(this.createCell(staff.name, 'staff-name'));
                    
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        const schedule = this.schedule[staff.id] && this.schedule[staff.id][day] ? 
                            this.schedule[staff.id][day] : 
                            { dayShift: false, nightShift: false, leave: staff.leaveRequests.includes(day) };
                        
                        let cellClass = 'grid-cell';
                        let content = '';
                        
                        if (schedule.leave) {
                            cellClass += ' leave-day';
                            content = 'å‡';
                        } else if (schedule.dayShift && schedule.nightShift) {
                            cellClass += ' shift-both';
                            content = 'æ—¥å¤œ';
                        } else if (schedule.dayShift) {
                            cellClass += ' shift-day';
                            content = 'æ—¥';
                        } else if (schedule.nightShift) {
                            cellClass += ' shift-night';
                            content = 'å¤œ';
                        }
                        
                        // æª¢æŸ¥æ˜¯å¦æœ‰é•è¦æƒ…æ³
                        const hasViolation = this.conflicts.some(c => 
                            c.type === 'rule_violation' && 
                            c.day === day && 
                            c.staff === staff.name
                        );
                        
                        if (hasViolation) {
                            cellClass += ' conflict';
                        }
                        
                        grid.appendChild(this.createCell(content, cellClass));
                    }
                });
            }

            createCell(content, className) {
                const cell = document.createElement('div');
                cell.className = className;
                cell.textContent = content;
                return cell;
            }

            renderStats() {
                const stats = document.getElementById('stats');
                
                if (!this.schedule || Object.keys(this.schedule).length === 0) {
                    stats.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-value">${this.staff.length}</div>
                            <div>ç¸½å“¡å·¥æ•¸</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div>ç¸½ç­æ¬¡æ•¸</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div>å¹³å‡ç­æ¬¡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div>å·¥æ™‚å·®ç•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div>å•é¡Œæ•¸é‡</div>
                        </div>
                    `;
                    return;
                }
                
                const workloadDetails = this.staff.map(staff => {
                    const workload = this.getWorkload(staff.id);
                    const dayShifts = this.getDayShiftCount(staff.id);
                    const nightShifts = this.getNightShiftCount(staff.id);
                    const totalShifts = dayShifts + nightShifts;
                    return {
                        name: staff.name,
                        workload: workload,
                        dayShifts: dayShifts,
                        nightShifts: nightShifts,
                        totalShifts: totalShifts
                    };
                });
                
                const totalShifts = workloadDetails.reduce((sum, w) => sum + w.totalShifts, 0);
                const avgShifts = totalShifts / this.staff.length;
                const workloads = workloadDetails.map(w => w.workload);
                const maxWorkload = Math.max(...workloads);
                const minWorkload = Math.min(...workloads);
                
                const workloadTable = workloadDetails
                    .sort((a, b) => b.totalShifts - a.totalShifts)
                    .map(w => `<div style="display: flex; justify-content: space-between; padding: 8px 12px; background: ${w.totalShifts > avgShifts + 2 ? '#ffebee' : w.totalShifts < avgShifts - 2 ? '#e8f5e8' : '#f8f9fa'}; margin: 3px 0; border-radius: 6px; border: 1px solid #dee2e6;">
                        <span style="font-weight: 500; color: #212529;">${w.name}</span>
                        <span style="font-weight: 600; color: #495057;">${w.totalShifts}ç­ (æ—¥:${w.dayShifts} å¤œ:${w.nightShifts})</span>
                    </div>`).join('');
                
                // è¨ˆç®—éœ€æ±‚æ»¿è¶³ç‡
                const dayShiftFulfillment = this.calculateDayShiftFulfillment();
                const nightShiftFulfillment = this.calculateNightShiftFulfillment();
                
                stats.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${this.staff.length}</div>
                        <div>ç¸½å“¡å·¥æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalShifts}</div>
                        <div>ç¸½ç­æ¬¡æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${avgShifts.toFixed(1)}</div>
                        <div>å¹³å‡ç­æ¬¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${((maxWorkload - minWorkload)/12).toFixed(1)}</div>
                        <div>ç­æ¬¡å·®ç•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${this.conflicts.length}</div>
                        <div>å•é¡Œæ•¸é‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${dayShiftFulfillment.toFixed(1)}%</div>
                        <div>ç™½ç­æ»¿è¶³ç‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${nightShiftFulfillment.toFixed(1)}%</div>
                        <div>å¤œç­æ»¿è¶³ç‡</div>
                    </div>
                    <div class="stat-card" style="grid-column: 1/-1;">
                        <h4 style="margin-bottom: 10px;">å€‹äººå·¥ä½œè² è·</h4>
                        ${workloadTable}
                    </div>
                `;
            }

            calculateNightShiftFulfillment() {
                let totalRequired = 0;
                let totalAssigned = 0;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const required = this.requirements[day].nightShift;
                    const assigned = this.staff.filter(staff => 
                        this.schedule[staff.id][day].nightShift).length;
                    
                    totalRequired += required;
                    totalAssigned += assigned;
                }
                
                return totalRequired > 0 ? (totalAssigned / totalRequired) * 100 : 100;
            }

            getDayShiftCount(staffId) {
                let count = 0;
                if (!this.schedule || !this.schedule[staffId]) return 0;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const schedule = this.schedule[staffId][day];
                    if (schedule && schedule.dayShift) count++;
                }
                return count;
            }

            getNightShiftCount(staffId) {
                let count = 0;
                if (!this.schedule || !this.schedule[staffId]) return 0;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const schedule = this.schedule[staffId][day];
                    if (schedule && schedule.nightShift) count++;
                }
                return count;
            }

            getWorkload(staffId) {
                let workload = 0;
                if (!this.schedule || !this.schedule[staffId]) return 0;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const schedule = this.schedule[staffId][day];
                    if (!schedule) continue;
                    
                    if (schedule.dayShift) workload += 12;
                    if (schedule.nightShift) workload += 12;
                }
                return workload;
            }

            exportSchedule() {
                let csv = 'å“¡å·¥å§“å';
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const dayName = this.getDayOfWeek(day);
                    csv += `,${day}æ—¥(${dayName})`;
                }
                csv += ',ç¸½å·¥æ™‚,æ—¥ç­æ¬¡æ•¸,å¤œç­æ¬¡æ•¸\n';
                
                this.staff.forEach(staff => {
                    csv += staff.name;
                    let totalHours = 0;
                    let dayCount = 0;
                    let nightCount = 0;
                    
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        const schedule = this.schedule[staff.id][day];
                        let cellValue = '';
                        
                        if (schedule.leave) {
                            cellValue = 'è«‹å‡';
                        } else if (schedule.dayShift && schedule.nightShift) {
                            cellValue = 'æ—¥å¤œç­';
                            totalHours += 24;
                            dayCount++;
                            nightCount++;
                        } else if (schedule.dayShift) {
                            cellValue = 'æ—¥ç­';
                            totalHours += 12;
                            dayCount++;
                        } else if (schedule.nightShift) {
                            cellValue = 'å¤œç­';
                            totalHours += 12;
                            nightCount++;
                        }
                        
                        csv += `,${cellValue}`;
                    }
                    
                    csv += `,${totalHours}å°æ™‚,${dayCount},${nightCount}\n`;
                });
                
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `æ€¥è¨ºæ’ç­è¡¨_${this.currentMonth}.csv`;
                link.click();
            }

            renderAll() {
                this.renderStaffGrid();
                this.renderRequirements();
                this.renderSchedule();
                this.renderStats();
                this.renderConflicts();
            }
        }

        // å…¨åŸŸå‡½æ•¸
        const scheduler = new EmergencyScheduler();

        function generateStaffList() {
            scheduler.generateStaffList();
        }

        function generateSchedule() {
            scheduler.generateSchedule();
        }

        function exportSchedule() {
            scheduler.exportSchedule();
        }

        // æ‘ºç–ŠåŠŸèƒ½
        window.toggleSection = function(sectionName) {
            const content = document.getElementById(sectionName + '-content');
            const icon = document.getElementById(sectionName + '-icon');
            
            if (content && icon) {
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    icon.classList.remove('collapsed');
                    icon.textContent = 'â–¼';
                } else {
                    content.classList.add('collapsed');
                    icon.classList.add('collapsed');
                    icon.textContent = 'â–¶';
                }
            }
        };

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            scheduler.init();
        });

        // æœˆä»½è®Šæ›´æ™‚æ›´æ–°
        document.getElementById('monthSelect').addEventListener('change', () => {
            scheduler.init();
        });
    </script>
</body>
</html>
