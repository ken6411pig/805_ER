<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ€¥è¨ºæ’ç­ç³»çµ± - å®Œæ•´æ•´åˆç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #007bff 0%, #667eea 50%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px 8px 0 0;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        /* åˆ†é ç³»çµ± */
        .tab-container {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-nav {
            display: flex;
            gap: 0;
        }

        .tab-button {
            background: #e9ecef;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            border-radius: 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button.active {
            background: white;
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }

        .tab-button:hover:not(.active) {
            background: #d4edda;
            color: #155724;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* å…±ç”¨æ§åˆ¶å€ */
        .global-controls {
            padding: 20px;
            background: #e8f4f8;
            border-bottom: 1px solid #bee5eb;
        }

        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        input, select, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            background: #007bff;
            color: white;
            border: 1px solid #007bff;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        button:hover {
            background: #0056b3;
        }

        button.secondary {
            background: #6c757d;
            border-color: #6c757d;
        }

        button.secondary:hover {
            background: #545b62;
        }

        /* è‡ªå‹•æ’ç­æ¨¡å¼æ¨£å¼ */
        .staff-section, .requirements-section {
            background: white;
            padding: 0;
            border-bottom: 1px solid #dee2e6;
        }

        .section-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .section-header:hover {
            background: #e9ecef;
        }

        .section-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collapse-icon {
            font-size: 14px;
            transition: transform 0.2s;
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 20px;
            display: block;
        }

        .section-content.collapsed {
            display: none;
        }

        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .staff-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .staff-card h4 {
            color: #495057;
            margin-bottom: 10px;
        }

        .leave-dates {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .leave-tag {
            background: #fff3cd;
            color: #856404;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            border: 1px solid #ffeaa7;
        }

        .optimization-section {
            background: #e8f4f8;
            border: 1px solid #bee5eb;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .optimization-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .option-card {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #bee5eb;
        }

        .option-card label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .option-description {
            font-size: 12px;
            color: #6c757d;
            margin-left: 20px;
        }

        /* æ‰‹å‹•ç·¨è¼¯æ¨¡å¼æ¨£å¼ */
        .shift-legend {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }

        /* æ’ç­è¡¨å…±ç”¨æ¨£å¼ */
        .schedule-container {
            padding: 20px;
        }

        .schedule-grid, .edit-grid {
            display: grid;
            gap: 1px;
            background: #ddd;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 15px;
        }

        .grid-header, .grid-cell, .edit-header, .edit-cell {
            background: white;
            padding: 6px 4px;
            text-align: center;
            font-size: 12px;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .grid-header, .edit-header {
            background: #495057;
            color: white;
            font-weight: 600;
        }

        .day-header {
            background: #6c757d !important;
            color: white;
            font-weight: 600;
            min-height: 50px !important;
        }

        .day-header.weekend {
            background: #dc3545 !important;
            color: white;
        }

        .day-number {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .day-name {
            font-size: 10px;
            opacity: 0.9;
        }

        .staff-name {
            background: #495057 !important;
            color: white;
            font-weight: 600;
            justify-content: flex-start;
            padding-left: 8px;
        }

        /* ç­åˆ¥é¡è‰² */
        .shift-day, .shift-O { background: #cce7ff !important; color: #004085; font-weight: 600; }
        .shift-night, .shift-N { background: #d4edda !important; color: #155724; font-weight: 600; }
        .shift-both { background: #ffeaa7 !important; color: #856404; font-weight: 600; }
        .shift-R { background: #fff3cd !important; color: #856404; font-weight: 600; }
        .shift-C { background: #f8d7da !important; color: #721c24; font-weight: 600; }
        .shift-S { background: #e2e3e5 !important; color: #383d41; font-weight: 600; }
        .leave-day, .leave { background: #fff3cd !important; color: #856404; }
        .conflict { background: #f8d7da !important; color: #721c24; }

        /* ç·¨è¼¯æ¨¡å¼å°ˆç”¨ */
        .edit-cell select {
            width: 100%;
            min-width: 30px;
            font-size: 11px;
            padding: 2px 4px;
            border: 1px solid #ccc;
            background: white;
        }

        /* çµ±è¨ˆå€åŸŸ */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: #007bff;
            color: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .workload-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .workload-table th,
        .workload-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .workload-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        /* æé†’å’Œè¡çª */
        .alert {
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .conflict-list {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
        }

        .conflict-item {
            color: #721c24;
            margin-bottom: 5px;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .schedule-grid, .edit-grid {
                font-size: 10px;
                grid-template-columns: 60px repeat(31, 1fr);
            }
            
            .grid-cell, .edit-cell {
                min-height: 30px;
                padding: 4px 2px;
            }
            
            .day-header {
                min-height: 40px !important;
            }

            .tab-button {
                padding: 12px 15px;
                font-size: 14px;
            }
        }

        /* æ¨¡å¼åˆ‡æ›æç¤º */
        .mode-info {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 12px 20px;
            margin: 20px;
            border-radius: 6px;
            text-align: center;
            font-weight: 500;
        }

        .requirements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .day-requirement {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            text-align: center;
        }

        .day-requirement.weekend {
            background: #fff5f5;
            border-color: #fed7d7;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .summary-card {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            text-align: center;
        }

        .summary-value {
            font-size: 20px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 12px;
            color: #6c757d;
        }

        .leave-analysis {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .leave-analysis h4 {
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .high-leave-days {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .leave-day-tag {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .leave-day-tag.medium {
            background: #fd7e14;
        }

        .leave-day-tag.low {
            background: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ æ€¥è¨ºæ’ç­ç³»çµ± - å®Œæ•´æ•´åˆç‰ˆ</h1>
            <p>è‡ªå‹•æ™ºèƒ½æ’ç­ â€¢ æ‰‹å‹•ç²¾ç´°èª¿æ•´ â€¢ å¤šç­åˆ¥æ”¯æ´ â€¢ å·¥æ™‚å¹³è¡¡</p>
            <p style="font-size: 14px; margin-top: 8px; opacity: 0.9;">
                è¦å‰‡ï¼šæ•´é«”é€£çºŒå·¥ä½œâ‰¤6å¤© â€¢ ç™½ç­é€£çºŒâ‰¤3å¤© â€¢ å¤œç­å¾Œä¸èƒ½æ¥ç™½ç­ â€¢ é å‡å‰ä¸€å¤©ä¸æ’å¤œç­ â€¢ æ¯æœˆæœ€å¾Œä¸€å¤©å¤œç­0äºº
            </p>
        </div>

        <!-- å…¨åŸŸæ§åˆ¶å€ -->
        <div class="global-controls">
            <div class="control-row">
                <div class="control-group">
                    <label>å¹´æœˆ</label>
                    <input type="month" id="monthSelect" value="2025-08">
                </div>
                <div class="control-group">
                    <label>å“¡å·¥äººæ•¸</label>
                    <input type="number" id="staffCount" min="8" max="12" value="10">
                </div>
                <button onclick="generateStaffList()">æ›´æ–°å“¡å·¥æ¸…å–®</button>
                <button onclick="exportSchedule()" class="secondary">ğŸ“‹ åŒ¯å‡ºæ’ç­è¡¨</button>
            </div>
        </div>

        <!-- åˆ†é å°èˆª -->
        <div class="tab-container">
            <div class="tab-nav">
                <button class="tab-button active" onclick="switchTab('auto')">
                    ğŸ¯ è‡ªå‹•æ’ç­
                </button>
                <button class="tab-button" onclick="switchTab('manual')">
                    âœï¸ æ‰‹å‹•ç·¨è¼¯
                </button>
            </div>
        </div>

        <!-- è‡ªå‹•æ’ç­åˆ†é  -->
        <div id="autoTab" class="tab-content active">
            <div class="mode-info">
                ğŸ¯ <strong>è‡ªå‹•æ’ç­æ¨¡å¼</strong> - ä½¿ç”¨AIç®—æ³•è‡ªå‹•ç”Ÿæˆå¹³è¡¡çš„æ’ç­è¡¨ï¼Œç¬¦åˆæ‰€æœ‰ç´„æŸè¦å‰‡
            </div>

            <!-- å„ªåŒ–é¸é … -->
            <div style="padding: 0 20px;">
                <div class="optimization-section">
                    <h4 style="color: #0c5460; margin-bottom: 10px;">ğŸ”§ æ’ç­å„ªåŒ–é¸é …</h4>
                    <div class="optimization-options">
                        <div class="option-card">
                            <label>
                                <input type="checkbox" id="enableContinuity" checked>
                                å•Ÿç”¨ç™½ç­é€£çºŒæ€§æ’ç­
                            </label>
                            <div class="option-description">
                                å„ªå…ˆå®‰æ’ç™½ç­é€£çºŒå·¥ä½œï¼ˆæœ€å¤š3å¤©ï¼‰ï¼Œç‚ºå…¶ä»–ç­åˆ¥ç•™ç©ºé–“
                            </div>
                        </div>
                        <div class="option-card">
                            <label>
                                <input type="checkbox" id="balanceWorkload" checked>
                                å·¥ä½œé‡å¹³è¡¡
                            </label>
                            <div class="option-description">
                                ç¢ºä¿æ¯å€‹äººçš„å·¥ä½œç­æ¬¡ç›¡é‡å¹³å‡åˆ†é…
                            </div>
                        </div>
                        <div class="option-card">
                            <label>
                                <input type="checkbox" id="avoidFragmentation" checked>
                                é¿å…é›¶ç¢ç™½ç­æ’ç­
                            </label>
                            <div class="option-description">
                                æ¸›å°‘å­¤ç«‹çš„ç™½ç­å·¥ä½œæ—¥ï¼Œæ–¹ä¾¿æ’å…¥å…¶ä»–ç­åˆ¥
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å“¡å·¥ç®¡ç† -->
            <div class="staff-section">
                <div class="section-header" onclick="toggleSection('staff')">
                    <h3>ğŸ‘¥ å“¡å·¥ç®¡ç†</h3>
                    <span class="collapse-icon" id="staff-icon">â–¼</span>
                </div>
                <div class="section-content" id="staff-content">
                    <div id="staffGrid" class="staff-grid"></div>
                </div>
            </div>

            <!-- äººåŠ›éœ€æ±‚è¨­å®š -->
            <div class="requirements-section">
                <div class="section-header" onclick="toggleSection('requirements')">
                    <h3>ğŸ“… æ¯æ—¥äººåŠ›éœ€æ±‚è¨­å®š</h3>
                    <span class="collapse-icon" id="requirements-icon">â–¼</span>
                </div>
                <div class="section-content" id="requirements-content">
                    <div class="stats-summary" id="requirementsSummary"></div>
                    <div id="leaveAnalysis"></div>
                    <div id="requirementsGrid" class="requirements-grid"></div>
                </div>
            </div>

            <!-- è‡ªå‹•æ’ç­æŒ‰éˆ• -->
            <div style="padding: 20px; text-align: center; background: #f8f9fa;">
                <button onclick="generateSchedule()" style="font-size: 18px; padding: 15px 30px; background: #28a745; border-color: #28a745;">
                    ğŸ¯ åŸ·è¡Œè‡ªå‹•æ’ç­
                </button>
                <p style="margin-top: 10px; color: #6c757d; font-size: 14px;">
                    å°‡æ ¹æ“šè¨­å®šçš„ç´„æŸè¦å‰‡å’Œå„ªåŒ–é¸é …è‡ªå‹•ç”Ÿæˆæ’ç­è¡¨
                </p>
            </div>
        </div>

        <!-- æ‰‹å‹•ç·¨è¼¯åˆ†é  -->
        <div id="manualTab" class="tab-content">
            <div class="mode-info">
                âœï¸ <strong>æ‰‹å‹•ç·¨è¼¯æ¨¡å¼</strong> - ç²¾ç´°èª¿æ•´æ’ç­è¡¨ï¼Œæ”¯æ´å¤šç¨®ç­åˆ¥ï¼Œå³æ™‚çµ±è¨ˆå·¥æ™‚
            </div>

            <!-- ç­åˆ¥èªªæ˜ -->
            <div style="padding: 0 20px;">
                <div class="shift-legend">
                    <h4 style="margin-bottom: 10px;">ğŸ¨ ç­åˆ¥èªªæ˜</h4>
                    <div class="legend-grid">
                        <div class="legend-item">
                            <div class="legend-color shift-O"></div>
                            <span><strong>O</strong> - ç™½ç­ (12å°æ™‚)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color shift-N"></div>
                            <span><strong>N</strong> - å¤œç­ (12å°æ™‚)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color shift-R"></div>
                            <span><strong>R</strong> - æ€¥æ•‘å®¤ (12å°æ™‚)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color shift-C"></div>
                            <span><strong>C</strong> - çœ‹è¨ºç­ (8å°æ™‚)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color shift-S"></div>
                            <span><strong>S</strong> - å¤–å‚·å°å¤œ (8å°æ™‚)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #fff3cd;"></div>
                            <span><strong>å‡</strong> - è«‹å‡</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç·¨è¼¯åŠŸèƒ½æŒ‰éˆ• -->
            <div style="padding: 0 20px;">
                <div class="control-row">
                    <button onclick="convertToEditMode()" style="background: #17a2b8; border-color: #17a2b8;">
                        ğŸ”„ è½‰æ›è‡ªå‹•æ’ç­çµæœ
                    </button>
                    <button onclick="clearAllShifts()" class="secondary">
                        ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰ç­åˆ¥
                    </button>
                    <button onclick="checkConflicts()" style="background: #ffc107; border-color: #ffc107; color: #212529;">
                        âš ï¸ æª¢æŸ¥è¡çª
                    </button>
                </div>
            </div>

            <!-- ç·¨è¼¯è¡¨æ ¼ -->
            <div class="schedule-container">
                <h3>ğŸ“‹ æ’ç­è¡¨ç·¨è¼¯</h3>
                <div id="alertContainer"></div>
                <div id="editGrid" class="edit-grid"></div>
                
                <div class="daily-stats">
                    <h4 style="margin: 20px 0 10px 0;">ğŸ“Š æ¯æ—¥ç­åˆ¥çµ±è¨ˆ</h4>
                    <div id="dailyStatsTable"></div>
                </div>
            </div>

            <!-- å€‹äººå·¥æ™‚çµ±è¨ˆ -->
            <div style="padding: 20px;">
                <h3>ğŸ“Š å€‹äººå·¥æ™‚è©³ç´°</h3>
                <table class="workload-table" id="workloadTable">
                    <thead>
                        <tr>
                            <th>å“¡å·¥å§“å</th>
                            <th>ç™½ç­(O)</th>
                            <th>å¤œç­(N)</th>
                            <th>æ€¥æ•‘å®¤(R)</th>
                            <th>çœ‹è¨ºç­(C)</th>
                            <th>å¤–å‚·å°å¤œ(S)</th>
                            <th>ç¸½ç­æ¬¡</th>
                            <th>ç¸½å·¥æ™‚</th>
                            <th>å¹³å‡æ—¥å·¥æ™‚</th>
                        </tr>
                    </thead>
                    <tbody id="workloadTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æ’ç­è¡¨é¡¯ç¤ºå€ï¼ˆå…©ç¨®æ¨¡å¼å…±ç”¨ï¼‰ -->
        <div class="schedule-container">
            <h3>ğŸ“‹ æ’ç­è¡¨</h3>
            <div id="conflictList"></div>
            <div id="scheduleGrid" class="schedule-grid"></div>
            
            <div class="stats" id="stats"></div>
        </div>
    </div>

    <script>
        class IntegratedScheduler {
            constructor() {
                this.staff = [];
                this.schedule = {};
                this.requirements = {};
                this.currentMonth = '';
                this.daysInMonth = 0;
                this.conflicts = [];
                this.currentMode = 'auto'; // 'auto' æˆ– 'manual'
                this.shiftHours = {
                    'O': 12,  // ç™½ç­
                    'N': 12,  // å¤œç­
                    'R': 12,  // æ€¥æ•‘å®¤
                    'C': 8,   // çœ‹è¨ºç­
                    'S': 8    // å¤–å‚·å°å¤œ
                };
            }

            init() {
                this.updateMonth();
                this.generateStaffList();
                this.generateRequirements();
                // åªåœ¨çœŸæ­£éœ€è¦æ™‚æ‰åˆå§‹åŒ–ç©ºæ’ç­
                if (!this.schedule || Object.keys(this.schedule).length === 0) {
                    this.initializeEmptySchedule();
                }
                this.renderAll();
            }

            updateMonth() {
                const monthInput = document.getElementById('monthSelect');
                this.currentMonth = monthInput.value;
                const date = new Date(this.currentMonth + '-01');
                this.daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            }

            getDayOfWeek(day) {
                const date = new Date(this.currentMonth + '-' + day.toString().padStart(2, '0'));
                const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                return dayNames[date.getDay()];
            }

            isWeekend(day) {
                const date = new Date(this.currentMonth + '-' + day.toString().padStart(2, '0'));
                const dayOfWeek = date.getDay();
                return dayOfWeek === 0 || dayOfWeek === 6;
            }

            generateStaffList() {
                this.updateMonth();
                const count = parseInt(document.getElementById('staffCount').value);
                
                const existingStaff = {};
                this.staff.forEach(s => {
                    existingStaff[s.id] = {
                        name: s.name,
                        leaveRequests: s.leaveRequests || []
                    };
                });

                this.staff = [];
                const defaultNames = ['ç‹é†«å¸«', 'æé†«å¸«', 'å¼µé†«å¸«', 'é™³é†«å¸«', 'æ—é†«å¸«', 'é»ƒé†«å¸«', 
                              'å³é†«å¸«', 'åŠ‰é†«å¸«', 'è”¡é†«å¸«', 'è¨±é†«å¸«', 'é„­é†«å¸«', 'è¬é†«å¸«'];
                
                for (let i = 0; i < count; i++) {
                    if (existingStaff[i]) {
                        this.staff.push({
                            id: i,
                            name: existingStaff[i].name,
                            leaveRequests: existingStaff[i].leaveRequests
                        });
                    } else {
                        const defaultName = defaultNames[i] || `é†«å¸«${i+1}`;
                        this.staff.push({
                            id: i,
                            name: defaultName,
                            leaveRequests: []
                        });
                    }
                }
                
                // åªåœ¨è‡ªå‹•æ’ç­æ¨¡å¼ä¸‹æ‰æ¸²æŸ“å“¡å·¥ç¶²æ ¼
                if (this.currentMode === 'auto') {
                    this.renderStaffGrid();
                }
                this.generateRequirements();
            }

            generateRequirements() {
                this.requirements = {};
                for (let day = 1; day <= this.daysInMonth; day++) {
                    this.requirements[day] = {
                        dayShift: 2,
                        nightShift: day === this.daysInMonth ? 0 : 2
                    };
                }
                this.renderRequirements();
            }

            initializeEmptySchedule() {
                this.schedule = {};
                this.staff.forEach(staff => {
                    this.schedule[staff.id] = {};
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        if (this.currentMode === 'auto') {
                            this.schedule[staff.id][day] = {
                                dayShift: false,
                                nightShift: false,
                                leave: staff.leaveRequests.includes(day)
                            };
                        } else {
                            this.schedule[staff.id][day] = {
                                shift: '', // 'O', 'N', 'R', 'C', 'S', æˆ–ç©ºå­—ä¸²
                                leave: staff.leaveRequests.includes(day)
                            };
                        }
                    }
                });
            }

            // ========== è‡ªå‹•æ’ç­æ ¸å¿ƒç®—æ³• ==========
            generateSchedule() {
                console.log('=== é–‹å§‹å®Œæ•´æ’ç­æµç¨‹ ===');
                
                this.schedule = {};
                this.conflicts = [];
                
                this.staff.forEach(staff => {
                    this.schedule[staff.id] = {};
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        this.schedule[staff.id][day] = {
                            dayShift: false,
                            nightShift: false,
                            leave: staff.leaveRequests.includes(day)
                        };
                    }
                });

                const nightShiftSuccess = this.scheduleNightShifts();
                
                if (!nightShiftSuccess) {
                    console.log('âŒ å¤œç­æ’ç­å¤±æ•—ï¼Œç„¡æ³•ç”¢ç”Ÿæœ‰æ•ˆæ’ç­è¡¨');
                    this.renderAll();
                    return;
                }

                console.log('âœ… å¤œç­æ’ç­å®Œæˆï¼Œé–‹å§‹æ’ç™½ç­');
                
                const dayShiftSuccess = this.scheduleDayShifts();
                
                if (!dayShiftSuccess) {
                    console.log('âŒ ç™½ç­æ’ç­å¤±æ•—ï¼Œä½†å¤œç­å·²å®Œæˆ');
                } else {
                    console.log('âœ… ç™½ç­æ’ç­å®Œæˆ');
                }
                
                this.checkConflicts();
                this.renderAll();
                this.showAlert('è‡ªå‹•æ’ç­å®Œæˆï¼å¯åˆ‡æ›åˆ°æ‰‹å‹•ç·¨è¼¯æ¨¡å¼é€²è¡Œèª¿æ•´', 'success');
            }

            scheduleNightShifts() {
                console.log('=== é–‹å§‹å¤œç­æ’ç­ ===');
                
                let maxAttempts = 10000;
                let bestSchedule = null;
                let bestBalance = Infinity;
                let perfectBalanceCount = 0;
                
                const totalNightShiftsNeeded = Object.values(this.requirements)
                    .reduce((sum, req) => sum + req.nightShift, 0);
                const targetNightShiftsPerPerson = Math.floor(totalNightShiftsNeeded / this.staff.length);
                
                console.log(`ç¸½å¤œç­éœ€æ±‚: ${totalNightShiftsNeeded}ç­`);
                console.log(`ç›®æ¨™æ¯äººå¤œç­æ•¸: ${targetNightShiftsPerPerson}ç­`);
                
                for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                    this.clearNightShifts();
                    
                    this.staff.forEach(staff => {
                        staff.currentNightShifts = 0;
                    });
                    
                    const success = this.scheduleNightShiftsImproved(targetNightShiftsPerPerson);
                    if (!success) continue;
                    
                    const balance = this.calculateNightShiftBalance();
                    
                    if (attempt % 200 === 0 || balance === 0) {
                        console.log(`ç¬¬${attempt}æ¬¡å¤œç­å˜—è©¦ - æœ€å¤§å·®è·: ${balance}ç­`);
                    }
                    
                    if (balance < bestBalance) {
                        bestBalance = balance;
                        bestSchedule = this.copyCurrentSchedule();
                        console.log(`ğŸ¯ ç™¼ç¾æ›´ä½³å¤œç­æ–¹æ¡ˆï¼æœ€å¤§å·®è·: ${balance}ç­ (ç¬¬${attempt}æ¬¡å˜—è©¦)`);
                    }
                    
                    if (balance === 0) {
                        perfectBalanceCount++;
                        if (perfectBalanceCount >= 3) {
                            console.log(`ğŸ‰ é€£çºŒæ‰¾åˆ°${perfectBalanceCount}æ¬¡å®Œå…¨å¹³è¡¡å¤œç­æ–¹æ¡ˆï¼æ¯äºº${targetNightShiftsPerPerson}ç­`);
                            break;
                        }
                    }
                    
                    if (bestBalance <= 1 && attempt >= 200) {
                        console.log(`âœ… å·²æ‰¾åˆ°å·®è·${bestBalance}ç­çš„è‰¯å¥½å¤œç­æ–¹æ¡ˆ`);
                        break;
                    }
                }
                
                if (bestSchedule && bestBalance <= 2) {
                    this.restoreSchedule(bestSchedule);
                    console.log(`ğŸ† æ¡ç”¨å¤œç­æ–¹æ¡ˆ - å·®è·: ${bestBalance}ç­`);
                    return true;
                } else {
                    console.log('âŒ æœªæ‰¾åˆ°åˆé©å¤œç­æ–¹æ¡ˆ');
                    return false;
                }
            }

            scheduleNightShiftsImproved(targetNightShifts) {
                const criticalDays = [];
                const normalDays = [];
                
                for (let day = 1; day <= this.daysInMonth - 1; day++) {
                    const needed = this.requirements[day].nightShift;
                    if (needed === 0) continue;
                    
                    const onLeave = this.staff.filter(s => s.leaveRequests.includes(day)).length;
                    const available = this.staff.length - onLeave;
                    
                    const isCritical = needed > 2 || onLeave >= 2 || (needed / available) > 0.3;
                    
                    if (isCritical) {
                        criticalDays.push(day);
                    } else {
                        normalDays.push(day);
                    }
                }
                
                for (const day of criticalDays) {
                    const needed = this.requirements[day].nightShift;
                    const selectedStaff = this.selectStaffForNightShift(day, needed, targetNightShifts);
                    
                    if (selectedStaff.length < needed) {
                        return false;
                    }
                    
                    selectedStaff.forEach(staff => {
                        this.schedule[staff.id][day].nightShift = true;
                        staff.currentNightShifts++;
                    });
                }
                
                for (let day = 1; day <= this.daysInMonth - 1; day++) {
                    if (criticalDays.includes(day)) continue;
                    
                    const needed = this.requirements[day].nightShift;
                    if (needed === 0) continue;
                    
                    const selectedStaff = this.selectStaffForNightShift(day, needed, targetNightShifts);
                    
                    if (selectedStaff.length < needed) {
                        return false;
                    }
                    
                    selectedStaff.forEach(staff => {
                        this.schedule[staff.id][day].nightShift = true;
                        staff.currentNightShifts++;
                    });
                }
                
                return true;
            }

            scheduleDayShifts() {
                console.log('=== é–‹å§‹ç™½ç­æ’ç­ ===');
                
                let maxAttempts = 1000;
                let bestSchedule = null;
                let bestBalance = Infinity;
                let bestFulfillment = 0;
                let bestAverageCount = 0;
                let bestContinuity = 0;
                
                const totalDayShiftsNeeded = Object.values(this.requirements)
                    .reduce((sum, req) => sum + req.dayShift, 0);
                const averageDayShifts = Math.round(totalDayShiftsNeeded / this.staff.length);
                const targetPeopleCount = this.staff.length - 3;
                
                console.log(`ç›®æ¨™ï¼š${targetPeopleCount}äººé”åˆ°å¹³å‡${averageDayShifts}ç­å³ç‚ºæœ€ä½³è§£`);
                
                for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                    this.clearDayShifts();
                    
                    this.staff.forEach(staff => {
                        staff.currentDayShifts = 0;
                    });
                    
                    this.assignDayShiftsWithContinuity();
                    
                    const balance = this.calculateDayShiftBalance();
                    const fulfillment = this.calculateDayShiftFulfillment();
                    const averageAchievers = this.countPeopleAtAverageDayShifts(averageDayShifts);
                    const continuity = this.calculateContinuityScore();
                    
                    if (attempt % 50 === 0 || averageAchievers >= targetPeopleCount || attempt <= 3) {
                        console.log(`ç¬¬${attempt}æ¬¡ç™½ç­å˜—è©¦ - å·®è·: ${balance}ç­, æ»¿è¶³: ${fulfillment.toFixed(1)}%, é”å¹³å‡äººæ•¸: ${averageAchievers}/${this.staff.length}, é€£çºŒæ€§: ${continuity.toFixed(1)}`);
                    }
                    
                    const isBetter = averageAchievers > bestAverageCount || 
                                   (averageAchievers === bestAverageCount && continuity > bestContinuity) ||
                                   (averageAchievers === bestAverageCount && continuity === bestContinuity && balance < bestBalance) ||
                                   (averageAchievers === bestAverageCount && continuity === bestContinuity && balance === bestBalance && fulfillment > bestFulfillment);
                    
                    if (isBetter) {
                        bestBalance = balance;
                        bestFulfillment = fulfillment;
                        bestAverageCount = averageAchievers;
                        bestContinuity = continuity;
                        bestSchedule = this.copyCurrentDaySchedule();
                    }
                    
                    if (averageAchievers >= targetPeopleCount && continuity >= 80) {
                        console.log(`ğŸ‰ é”æˆç›®æ¨™ï¼${averageAchievers}äººé”åˆ°å¹³å‡${averageDayShifts}ç­ï¼Œé€£çºŒæ€§${continuity.toFixed(1)}%`);
                        break;
                    }
                    
                    if (averageAchievers >= targetPeopleCount - 1 && balance <= 2 && attempt >= 500) {
                        break;
                    }
                }
                
                if (bestSchedule) {
                    this.restoreDaySchedule(bestSchedule);
                    console.log(`ğŸ† æ¡ç”¨æœ€ä½³ç™½ç­æ–¹æ¡ˆ - é”å¹³å‡: ${bestAverageCount}äºº, é€£çºŒæ€§: ${bestContinuity.toFixed(1)}%, å·®è·: ${bestBalance}ç­`);
                    return true;
                } else {
                    console.log('âŒ æœªæ‰¾åˆ°å¯è¡Œç™½ç­æ–¹æ¡ˆ');
                    return false;
                }
            }

            // ========== è¼”åŠ©æ–¹æ³• ==========
            selectStaffForNightShift(day, needed, targetNightShifts = 5) {
                const groups = this.groupStaffByNightPriority(day, targetNightShifts);
                const selectedStaff = [];
                
                if (groups.high.length > 0) {
                    const highPicks = Math.min(needed, groups.high.length);
                    const shuffled = this.shuffleArray([...groups.high]);
                    selectedStaff.push(...shuffled.slice(0, highPicks));
                }
                
                if (selectedStaff.length < needed && groups.medium.length > 0) {
                    const mediumNeeded = needed - selectedStaff.length;
                    const mediumPicks = Math.min(mediumNeeded, groups.medium.length);
                    const shuffled = this.shuffleArray([...groups.medium]);
                    selectedStaff.push(...shuffled.slice(0, mediumPicks));
                }
                
                if (selectedStaff.length < needed && groups.low.length > 0) {
                    const lowNeeded = needed - selectedStaff.length;
                    const lowPicks = Math.min(lowNeeded, groups.low.length);
                    const shuffled = this.shuffleArray([...groups.low]);
                    selectedStaff.push(...shuffled.slice(0, lowPicks));
                }
                
                return selectedStaff;
            }

            groupStaffByNightPriority(day, targetNightShifts = 5) {
                const groups = { high: [], medium: [], low: [] };
                
                this.staff.forEach(staff => {
                    if (!this.canWorkNightShift(staff.id, day)) {
                        return;
                    }
                    
                    const nightShifts = staff.currentNightShifts;
                    const hadNightYesterday = day > 1 && this.schedule[staff.id][day-1].nightShift;
                    
                    if (nightShifts < targetNightShifts && hadNightYesterday) {
                        groups.high.push(staff);
                    }
                    else if (nightShifts < targetNightShifts) {
                        groups.medium.push(staff);
                    }
                    else {
                        groups.low.push(staff);
                    }
                });
                
                return groups;
            }

            canWorkNightShift(staffId, day) {
                if (this.schedule[staffId][day].leave) return false;
                if (this.schedule[staffId][day].nightShift) return false;
                if (day === this.daysInMonth) return false;
                
                const staff = this.staff.find(s => s.id === staffId);
                if (staff && staff.leaveRequests.includes(day + 1)) return false;
                
                return true;
            }

            assignDayShiftsWithContinuity() {
                const enableContinuity = document.getElementById('enableContinuity').checked;
                const balanceWorkload = document.getElementById('balanceWorkload').checked;
                const avoidFragmentation = document.getElementById('avoidFragmentation').checked;
                
                const totalNightShiftsNeeded = Object.values(this.requirements)
                    .reduce((sum, req) => sum + req.nightShift, 0);
                const targetNightShifts = Math.floor(totalNightShiftsNeeded / this.staff.length);
                const maxConsecutiveDays = targetNightShifts;
                const maxConsecutiveDayShifts = 3;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const needed = this.requirements[day].dayShift;
                    if (needed === 0) continue;
                    
                    const availableStaff = this.getAvailableStaffForDayShift(day, maxConsecutiveDays, maxConsecutiveDayShifts);
                    
                    if (availableStaff.length === 0) continue;
                    
                    availableStaff.sort((a, b) => {
                        let scoreA = 0;
                        let scoreB = 0;
                        
                        if (balanceWorkload) {
                            const aDayShifts = a.currentDayShifts || 0;
                            const bDayShifts = b.currentDayShifts || 0;
                            scoreA += (10 - aDayShifts) * 10;
                            scoreB += (10 - bDayShifts) * 10;
                        }
                        
                        if (enableContinuity) {
                            const aWorkedDayYesterday = day > 1 && this.schedule[a.id][day-1].dayShift;
                            const bWorkedDayYesterday = day > 1 && this.schedule[b.id][day-1].dayShift;
                            
                            const aConsecutiveDayShifts = this.getConsecutiveDayShifts(a.id, day);
                            const bConsecutiveDayShifts = this.getConsecutiveDayShifts(b.id, day);
                            
                            if (aWorkedDayYesterday && aConsecutiveDayShifts < maxConsecutiveDayShifts) {
                                scoreA += 40;
                            }
                            if (bWorkedDayYesterday && bConsecutiveDayShifts < maxConsecutiveDayShifts) {
                                scoreB += 40;
                            }
                        }
                        
                        if (avoidFragmentation) {
                            const aFragmentation = this.calculateDayShiftFragmentationPenalty(a.id, day);
                            const bFragmentation = this.calculateDayShiftFragmentationPenalty(b.id, day);
                            scoreA -= aFragmentation * 12;
                            scoreB -= bFragmentation * 12;
                        }
                        
                        scoreA += Math.random() * 5;
                        scoreB += Math.random() * 5;
                        
                        return scoreB - scoreA;
                    });
                    
                    const selectedCount = Math.min(needed, availableStaff.length);
                    const selectedStaff = availableStaff.slice(0, selectedCount);
                    
                    selectedStaff.forEach(staff => {
                        this.schedule[staff.id][day].dayShift = true;
                        staff.currentDayShifts = (staff.currentDayShifts || 0) + 1;
                    });
                }
            }

            getAvailableStaffForDayShift(day, maxConsecutiveDays = 6, maxConsecutiveDayShifts = 3) {
                const availableStaff = [];
                
                this.staff.forEach(staff => {
                    const isOnLeave = this.schedule[staff.id][day].leave;
                    const alreadyDayShift = this.schedule[staff.id][day].dayShift;
                    const hasNightToday = this.schedule[staff.id][day].nightShift;
                    const hadNightYesterday = day > 1 && this.schedule[staff.id][day-1].nightShift;
                    
                    if (isOnLeave || alreadyDayShift || hasNightToday || hadNightYesterday) return;
                    
                    const consecutiveDaysIfWork = this.getConsecutiveDaysIncludingToday(staff.id, day);
                    if (consecutiveDaysIfWork > maxConsecutiveDays) return;
                    
                    const consecutiveDayShifts = this.getConsecutiveDayShifts(staff.id, day);
                    if (consecutiveDayShifts >= maxConsecutiveDayShifts) return;
                    
                    availableStaff.push(staff);
                });
                
                return availableStaff;
            }

            getConsecutiveDayShifts(staffId, currentDay) {
                let consecutiveDayShifts = 0;
                
                for (let day = currentDay - 1; day >= 1; day--) {
                    if (this.schedule[staffId][day].dayShift) {
                        consecutiveDayShifts++;
                    } else {
                        break;
                    }
                }
                
                return consecutiveDayShifts;
            }

            getConsecutiveDaysIncludingToday(staffId, currentDay) {
                let consecutiveDays = 1;
                
                for (let day = currentDay - 1; day >= 1; day--) {
                    const hasWork = this.schedule[staffId][day].dayShift || this.schedule[staffId][day].nightShift;
                    if (hasWork) {
                        consecutiveDays++;
                    } else {
                        break;
                    }
                }
                
                for (let day = currentDay + 1; day <= this.daysInMonth; day++) {
                    const hasWork = this.schedule[staffId][day].dayShift || this.schedule[staffId][day].nightShift;
                    if (hasWork) {
                        consecutiveDays++;
                    } else {
                        break;
                    }
                }
                
                return consecutiveDays;
            }

            calculateDayShiftFragmentationPenalty(staffId, day) {
                let penalty = 0;
                
                const workedDayYesterday = day > 1 && this.schedule[staffId][day-1].dayShift;
                const willWorkDayTomorrow = day < this.daysInMonth && this.schedule[staffId][day+1].dayShift;
                
                if (!workedDayYesterday && !willWorkDayTomorrow) {
                    penalty += 8;
                }
                
                return penalty;
            }

            calculateContinuityScore() {
                let totalScore = 0;
                let totalPossibleScore = 0;
                
                this.staff.forEach(staff => {
                    const workDays = [];
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        if (this.schedule[staff.id][day].dayShift || this.schedule[staff.id][day].nightShift) {
                            workDays.push(day);
                        }
                    }
                    
                    if (workDays.length <= 1) {
                        totalPossibleScore += workDays.length;
                        totalScore += workDays.length;
                        return;
                    }
                    
                    let continuousBlocks = 0;
                    let currentBlockLength = 1;
                    
                    for (let i = 1; i < workDays.length; i++) {
                        if (workDays[i] === workDays[i-1] + 1) {
                            currentBlockLength++;
                        } else {
                            continuousBlocks += currentBlockLength * currentBlockLength;
                            currentBlockLength = 1;
                        }
                    }
                    continuousBlocks += currentBlockLength * currentBlockLength;
                    
                    totalScore += continuousBlocks;
                    totalPossibleScore += workDays.length * workDays.length;
                });
                
                return totalPossibleScore > 0 ? (totalScore / totalPossibleScore) * 100 : 100;
            }

            countPeopleAtAverageDayShifts(averageDayShifts) {
                return this.staff.filter(staff => 
                    (staff.currentDayShifts || 0) === averageDayShifts
                ).length;
            }

            calculateNightShiftBalance() {
                const nightCounts = this.staff.map(staff => staff.currentNightShifts);
                const maxNights = Math.max(...nightCounts);
                const minNights = Math.min(...nightCounts);
                return maxNights - minNights;
            }

            calculateDayShiftBalance() {
                const dayCounts = this.staff.map(staff => staff.currentDayShifts || 0);
                const maxDays = Math.max(...dayCounts);
                const minDays = Math.min(...dayCounts);
                return maxDays - minDays;
            }

            calculateDayShiftFulfillment() {
                let totalRequired = 0;
                let totalAssigned = 0;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const required = this.requirements[day].dayShift;
                    const assigned = this.staff.filter(staff => 
                        this.schedule[staff.id][day].dayShift).length;
                    
                    totalRequired += required;
                    totalAssigned += assigned;
                }
                
                return totalRequired > 0 ? (totalAssigned / totalRequired) * 100 : 100;
            }

            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            clearNightShifts() {
                this.staff.forEach(staff => {
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        if (this.schedule[staff.id] && this.schedule[staff.id][day]) {
                            this.schedule[staff.id][day].nightShift = false;
                        }
                    }
                });
            }

            clearDayShifts() {
                this.staff.forEach(staff => {
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        if (this.schedule[staff.id] && this.schedule[staff.id][day]) {
                            this.schedule[staff.id][day].dayShift = false;
                        }
                    }
                });
            }

            copyCurrentSchedule() {
                const copy = {};
                this.staff.forEach(staff => {
                    copy[staff.id] = {};
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        copy[staff.id][day] = {
                            ...this.schedule[staff.id][day]
                        };
                    }
                });
                
                const staffCounts = {};
                this.staff.forEach(staff => {
                    staffCounts[staff.id] = {
                        nightShifts: staff.currentNightShifts,
                        dayShifts: staff.currentDayShifts || 0
                    };
                });
                
                return { schedule: copy, counts: staffCounts };
            }

            copyCurrentDaySchedule() {
                const copy = {};
                this.staff.forEach(staff => {
                    copy[staff.id] = {};
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        copy[staff.id][day] = {
                            dayShift: this.schedule[staff.id][day].dayShift,
                            nightShift: this.schedule[staff.id][day].nightShift,
                            leave: this.schedule[staff.id][day].leave
                        };
                    }
                });
                
                const staffCounts = {};
                this.staff.forEach(staff => {
                    staffCounts[staff.id] = staff.currentDayShifts || 0;
                });
                
                return { schedule: copy, counts: staffCounts };
            }

            restoreSchedule(saved) {
                this.schedule = saved.schedule;
                
                this.staff.forEach(staff => {
                    staff.currentNightShifts = saved.counts[staff.id].nightShifts;
                    staff.currentDayShifts = saved.counts[staff.id].dayShifts;
                });
            }

            restoreDaySchedule(saved) {
                this.staff.forEach(staff => {
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        this.schedule[staff.id][day].dayShift = saved.schedule[staff.id][day].dayShift;
                    }
                    staff.currentDayShifts = saved.counts[staff.id];
                });
            }

            // ========== æ‰‹å‹•ç·¨è¼¯æ¨¡å¼æ–¹æ³• ==========
            convertToEditMode() {
                // å°‡è‡ªå‹•æ’ç­çµæœè½‰æ›ç‚ºç·¨è¼¯æ¨¡å¼æ ¼å¼
                if (!this.schedule || Object.keys(this.schedule).length === 0) {
                    this.showAlert('è«‹å…ˆåŸ·è¡Œè‡ªå‹•æ’ç­', 'warning');
                    return;
                }

                // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„æ’ç­è³‡æ–™
                let hasValidSchedule = false;
                for (let staffId in this.schedule) {
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        const schedule = this.schedule[staffId][day];
                        if (schedule && (schedule.dayShift || schedule.nightShift)) {
                            hasValidSchedule = true;
                            break;
                        }
                    }
                    if (hasValidSchedule) break;
                }

                if (!hasValidSchedule) {
                    this.showAlert('æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„è‡ªå‹•æ’ç­çµæœï¼Œè«‹å…ˆåŸ·è¡Œè‡ªå‹•æ’ç­', 'warning');
                    return;
                }

                console.log('é–‹å§‹è½‰æ›è‡ªå‹•æ’ç­çµæœåˆ°æ‰‹å‹•ç·¨è¼¯æ¨¡å¼...');
                
                const newSchedule = {};
                let convertedCount = 0;
                
                this.staff.forEach(staff => {
                    newSchedule[staff.id] = {};
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        const autoSchedule = this.schedule[staff.id][day];
                        
                        if (autoSchedule.leave) {
                            newSchedule[staff.id][day] = { shift: '', leave: true };
                        } else if (autoSchedule.dayShift && autoSchedule.nightShift) {
                            // å¦‚æœåŒæ™‚æœ‰ç™½ç­å’Œå¤œç­ï¼Œåœ¨ç·¨è¼¯æ¨¡å¼ä¸­é è¨­ç‚ºç™½ç­ï¼Œç”¨æˆ¶å¯æ‰‹å‹•èª¿æ•´
                            newSchedule[staff.id][day] = { shift: 'O', leave: false };
                            convertedCount++;
                            console.log(`${staff.name} ç¬¬${day}å¤©: O+N -> O (éœ€æ‰‹å‹•èª¿æ•´å¤œç­)`);
                        } else if (autoSchedule.dayShift) {
                            newSchedule[staff.id][day] = { shift: 'O', leave: false };
                            convertedCount++;
                        } else if (autoSchedule.nightShift) {
                            newSchedule[staff.id][day] = { shift: 'N', leave: false };
                            convertedCount++;
                        } else {
                            newSchedule[staff.id][day] = { shift: '', leave: false };
                        }
                    }
                });
                
                console.log(`è½‰æ›å®Œæˆï¼Œå…±è½‰æ›äº† ${convertedCount} å€‹ç­æ¬¡`);
                
                // æ›´æ–°æ’ç­è³‡æ–™å’Œæ¨¡å¼
                this.schedule = newSchedule;
                this.currentMode = 'manual';
                
                // åˆ‡æ›åˆ°æ‰‹å‹•ç·¨è¼¯åˆ†é 
                switchTab('manual');
                
                this.showAlert(`å·²è½‰æ›ç‚ºæ‰‹å‹•ç·¨è¼¯æ¨¡å¼ï¼Œå…±è½‰æ›äº† ${convertedCount} å€‹ç­æ¬¡ã€‚å¯ä»¥é€²è¡Œç²¾ç´°èª¿æ•´`, 'success');
            }

            updateScheduleManual(staffId, day, value) {
                if (value === 'leave') {
                    this.schedule[staffId][day] = { shift: '', leave: true };
                } else {
                    this.schedule[staffId][day] = { shift: value, leave: false };
                }
                
                this.renderEditMode();
            }

            calculateWorkload(staffId) {
                const workload = {
                    O: 0, N: 0, R: 0, C: 0, S: 0,
                    totalShifts: 0,
                    totalHours: 0
                };

                for (let day = 1; day <= this.daysInMonth; day++) {
                    const schedule = this.schedule[staffId][day];
                    if (schedule.shift && !schedule.leave) {
                        workload[schedule.shift]++;
                        workload.totalShifts++;
                        workload.totalHours += this.shiftHours[schedule.shift];
                    }
                }

                workload.avgDailyHours = (workload.totalHours / this.daysInMonth).toFixed(1);
                
                return workload;
            }

            clearAllShifts() {
                if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç­åˆ¥å—ï¼Ÿé€™å€‹æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                    return;
                }

                this.staff.forEach(staff => {
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        this.schedule[staff.id][day] = { shift: '', leave: false };
                    }
                });

                this.showAlert('å·²æ¸…ç©ºæ‰€æœ‰ç­åˆ¥', 'success');
                this.renderEditMode();
            }

            // ========== è¡çªæª¢æŸ¥ ==========
            checkConflicts() {
                this.conflicts = [];
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    this.staff.forEach(staff => {
                        if (this.currentMode === 'auto') {
                            const schedule = this.schedule[staff.id][day];
                            
                            if (day > 1 && this.schedule[staff.id][day-1].nightShift && schedule.dayShift) {
                                this.conflicts.push({
                                    type: 'rule_violation',
                                    day: day,
                                    staff: staff.name,
                                    rule: 'å¤œç­å¾Œä¸èƒ½æ¥ç™½ç­'
                                });
                            }
                            
                            if (schedule.dayShift && schedule.nightShift) {
                                this.conflicts.push({
                                    type: 'rule_violation',
                                    day: day,
                                    staff: staff.name,
                                    rule: 'åŒä¸€å¤©ä¸èƒ½æ—¢ä¸Šæ—¥ç­åˆä¸Šå¤œç­'
                                });
                            }
                        } else {
                            const today = this.schedule[staff.id][day];
                            
                            if (day > 1) {
                                const yesterday = this.schedule[staff.id][day - 1];
                                if (yesterday.shift === 'N' && (today.shift === 'O' || today.shift === 'R')) {
                                    this.conflicts.push({
                                        type: 'rule_violation',
                                        staff: staff.name,
                                        day: day,
                                        message: `${staff.name} åœ¨${day-1}æ—¥å¤œç­å¾Œï¼Œ${day}æ—¥ä¸æ‡‰æ’ç™½ç­æˆ–æ€¥æ•‘å®¤`
                                    });
                                }
                            }
                        }
                    });
                }
                
                if (this.conflicts.length === 0) {
                    this.showAlert('æ²’æœ‰ç™¼ç¾æ’ç­è¡çªï¼', 'success');
                } else {
                    let alertMessage = `ç™¼ç¾ ${this.conflicts.length} å€‹è¡çªï¼š\n`;
                    this.conflicts.slice(0, 5).forEach(c => {
                        if (c.message) {
                            alertMessage += `â€¢ ${c.message}\n`;
                        } else {
                            alertMessage += `â€¢ ${c.day}æ—¥ ${c.staff} é•åè¦å‰‡ï¼š${c.rule}\n`;
                        }
                    });
                    if (this.conflicts.length > 5) {
                        alertMessage += `... é‚„æœ‰ ${this.conflicts.length - 5} å€‹è¡çª`;
                    }
                    this.showAlert(alertMessage, 'error');
                }
                
                this.renderConflicts();
            }

            renderConflicts() {
                const conflictList = document.getElementById('conflictList');
                
                if (this.conflicts.length === 0) {
                    conflictList.innerHTML = '';
                    return;
                }
                
                conflictList.innerHTML = `
                    <div class="conflict-list">
                        <h4>âš ï¸ æ’ç­å•é¡Œ</h4>
                        ${this.conflicts.map(conflict => {
                            if (conflict.type === 'understaffed') {
                                const shiftName = conflict.shift === 'day' ? 'ç™½ç­' : 'å¤œç­';
                                return `<div class="conflict-item">
                                    ${conflict.day}æ—¥ ${shiftName} äººåŠ›ä¸è¶³ï¼šéœ€è¦${conflict.needed}äººï¼Œå¯¦éš›${conflict.actual}äºº
                                </div>`;
                            } else if (conflict.type === 'rule_violation') {
                                return `<div class="conflict-item">
                                    ${conflict.day}æ—¥ ${conflict.staff} é•åè¦å‰‡ï¼š${conflict.rule}
                                </div>`;
                            } else if (conflict.message) {
                                return `<div class="conflict-item">${conflict.message}</div>`;
                            }
                            return '';
                        }).join('')}
                    </div>
                `;
            }

            // ========== æ¸²æŸ“æ–¹æ³• ==========
            renderStaffGrid() {
                const grid = document.getElementById('staffGrid');
                grid.innerHTML = '';
                
                this.staff.forEach(staff => {
                    const card = document.createElement('div');
                    card.className = 'staff-card';
                    card.innerHTML = `
                        <div class="staff-header">
                            <div class="control-group" style="margin-bottom: 10px;">
                                <label>å“¡å·¥å§“å</label>
                                <input type="text" 
                                       value="${staff.name}"
                                       onchange="scheduler.updateStaffName(${staff.id}, this.value)"
                                       placeholder="è«‹è¼¸å…¥å“¡å·¥å§“å"
                                       style="font-weight: 600; background: #fff; border: 2px solid #dee2e6;">
                            </div>
                        </div>
                        <div class="control-group">
                            <label>è«‹å‡æ—¥æœŸ (ä»¥é€—è™Ÿåˆ†éš”ï¼Œå¦‚: 5,12,20)</label>
                            <input type="text" 
                                   value="${staff.leaveRequests.join(',')}"
                                   onchange="scheduler.updateLeave(${staff.id}, this.value)"
                                   placeholder="è«‹è¼¸å…¥è«‹å‡æ—¥æœŸ">
                        </div>
                        <div class="leave-dates">
                            ${staff.leaveRequests.map(date => 
                                `<span class="leave-tag">${date}æ—¥</span>`
                            ).join('')}
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }

            renderRequirements() {
                this.renderRequirementsSummary();
                this.renderLeaveAnalysis();
                this.renderRequirementsGrid();
            }

            renderRequirementsSummary() {
                const summary = document.getElementById('requirementsSummary');
                
                let totalDayShifts = 0;
                let totalNightShifts = 0;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    totalDayShifts += this.requirements[day].dayShift;
                    totalNightShifts += this.requirements[day].nightShift;
                }
                
                const avgDayShifts = (totalDayShifts / this.staff.length).toFixed(1);
                const avgNightShifts = (totalNightShifts / this.staff.length).toFixed(1);
                
                summary.innerHTML = `
                    <div class="summary-card">
                        <div class="summary-value">${totalDayShifts}</div>
                        <div class="summary-label">ç¸½ç™½ç­éœ€æ±‚</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${totalNightShifts}</div>
                        <div class="summary-label">ç¸½å¤œç­éœ€æ±‚</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${avgDayShifts}</div>
                        <div class="summary-label">å¹³å‡ç™½ç­/äºº</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${avgNightShifts}</div>
                        <div class="summary-label">å¹³å‡å¤œç­/äºº</div>
                    </div>
                `;
            }

            renderLeaveAnalysis() {
                const analysis = document.getElementById('leaveAnalysis');
                
                const leaveCounts = {};
                for (let day = 1; day <= this.daysInMonth; day++) {
                    leaveCounts[day] = 0;
                }
                
                this.staff.forEach(staff => {
                    staff.leaveRequests.forEach(day => {
                        if (day >= 1 && day <= this.daysInMonth) {
                            leaveCounts[day]++;
                        }
                    });
                });
                
                const highLeaveDays = [];
                const mediumLeaveDays = [];
                const lowLeaveDays = [];
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const count = leaveCounts[day];
                    const dayName = this.getDayOfWeek(day);
                    const dayInfo = `${day}(${dayName})`;
                    
                    if (count >= 3) {
                        highLeaveDays.push({ day: dayInfo, count });
                    } else if (count === 2) {
                        mediumLeaveDays.push({ day: dayInfo, count });
                    } else if (count === 1) {
                        lowLeaveDays.push({ day: dayInfo, count });
                    }
                }
                
                if (highLeaveDays.length === 0 && mediumLeaveDays.length === 0 && lowLeaveDays.length === 0) {
                    analysis.innerHTML = `
                        <div class="leave-analysis">
                            <h4>ğŸ“Š è«‹å‡åˆ†æ</h4>
                            <p style="color: #28a745; margin: 0;">ç›®å‰æ²’æœ‰å“¡å·¥è«‹å‡ï¼ŒäººåŠ›å……è¶³ï¼</p>
                        </div>
                    `;
                    return;
                }
                
                analysis.innerHTML = `
                    <div class="leave-analysis">
                        <h4>ğŸ“Š è«‹å‡åˆ†æ - å»ºè­°èª¿æ•´äººåŠ›éœ€æ±‚</h4>
                        <div class="high-leave-days">
                            ${highLeaveDays.map(item => 
                                `<span class="leave-day-tag">${item.day}: ${item.count}äººè«‹å‡</span>`
                            ).join('')}
                            ${mediumLeaveDays.map(item => 
                                `<span class="leave-day-tag medium">${item.day}: ${item.count}äººè«‹å‡</span>`
                            ).join('')}
                            ${lowLeaveDays.map(item => 
                                `<span class="leave-day-tag low">${item.day}: ${item.count}äººè«‹å‡</span>`
                            ).join('')}
                        </div>
                        ${highLeaveDays.length > 0 ? 
                            `<p style="margin-top: 10px; color: #856404; font-size: 14px;">
                                âš ï¸ ç´…è‰²æ¨™è¨˜çš„æ—¥æœŸè«‹å‡äººæ•¸è¼ƒå¤šï¼Œå»ºè­°é©ç•¶é™ä½ç•¶å¤©çš„äººåŠ›éœ€æ±‚ä»¥æé«˜æ’ç­æˆåŠŸç‡
                            </p>` : ''
                        }
                    </div>
                `;
            }

            renderRequirementsGrid() {
                const grid = document.getElementById('requirementsGrid');
                grid.innerHTML = '';
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const card = document.createElement('div');
                    const isWeekendDay = this.isWeekend(day);
                    const dayName = this.getDayOfWeek(day);
                    
                    const leaveCount = this.staff.filter(staff => 
                        staff.leaveRequests.includes(day)
                    ).length;
                    
                    card.className = `day-requirement ${isWeekendDay ? 'weekend' : ''}`;
                    card.innerHTML = `
                        <strong>${day} (${dayName})</strong>
                        ${leaveCount > 0 ? `<div style="color: #dc3545; font-size: 11px; margin: 2px 0;">${leaveCount}äººè«‹å‡</div>` : ''}
                        <div style="margin: 8px 0;">
                            <label>ç™½ç­</label>
                            <input type="number" min="1" max="3" 
                                   value="${this.requirements[day].dayShift}"
                                   onchange="scheduler.updateRequirement(${day}, 'dayShift', this.value)"
                                   style="width: 50px; margin-left: 5px;">
                        </div>
                        <div>
                            <label>å¤œç­</label>
                            <input type="number" min="0" max="3" 
                                   value="${this.requirements[day].nightShift}"
                                   onchange="scheduler.updateRequirement(${day}, 'nightShift', this.value)"
                                   style="width: 50px; margin-left: 5px;"
                                   ${day === this.daysInMonth ? 'disabled' : ''}>
                        </div>
                    `;
                    grid.appendChild(card);
                }
            }

            renderSchedule() {
                const grid = document.getElementById('scheduleGrid');
                grid.innerHTML = '';
                
                if (!this.schedule || Object.keys(this.schedule).length === 0) {
                    grid.innerHTML = '<div class="grid-cell">è«‹å…ˆé»æ“Šã€ŒåŸ·è¡Œè‡ªå‹•æ’ç­ã€æˆ–åˆ‡æ›åˆ°æ‰‹å‹•ç·¨è¼¯æ¨¡å¼</div>';
                    return;
                }
                
                grid.style.gridTemplateColumns = `80px repeat(${this.daysInMonth}, 1fr)`;
                
                grid.appendChild(this.createCell('', 'grid-header'));
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const dayName = this.getDayOfWeek(day);
                    const isWeekendDay = this.isWeekend(day);
                    const headerClass = `day-header ${isWeekendDay ? 'weekend' : ''}`;
                    
                    const cell = document.createElement('div');
                    cell.className = headerClass;
                    cell.innerHTML = `
                        <div class="day-number">${day}</div>
                        <div class="day-name">${dayName}</div>
                    `;
                    grid.appendChild(cell);
                }
                
                this.staff.forEach(staff => {
                    grid.appendChild(this.createCell(staff.name, 'staff-name'));
                    
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        const schedule = this.schedule[staff.id] && this.schedule[staff.id][day] ? 
                            this.schedule[staff.id][day] : 
                            { dayShift: false, nightShift: false, leave: staff.leaveRequests.includes(day) };
                        
                        let cellClass = 'grid-cell';
                        let content = '';
                        
                        if (this.currentMode === 'auto') {
                            if (schedule.leave) {
                                cellClass += ' leave-day';
                                content = 'å‡';
                            } else if (schedule.dayShift && schedule.nightShift) {
                                cellClass += ' shift-both';
                                content = 'O+N';
                            } else if (schedule.dayShift) {
                                cellClass += ' shift-day';
                                content = 'O';
                            } else if (schedule.nightShift) {
                                cellClass += ' shift-night';
                                content = 'N';
                            }
                        } else {
                            if (schedule.leave) {
                                cellClass += ' leave';
                                content = 'å‡';
                            } else if (schedule.shift) {
                                cellClass += ` shift-${schedule.shift}`;
                                content = schedule.shift;
                            }
                        }
                        
                        const hasViolation = this.conflicts.some(c => 
                            c.type === 'rule_violation' && 
                            c.day === day && 
                            c.staff === staff.name
                        );
                        
                        if (hasViolation) {
                            cellClass += ' conflict';
                        }
                        
                        grid.appendChild(this.createCell(content, cellClass));
                    }
                });
            }

            renderEditGrid() {
                const grid = document.getElementById('editGrid');
                grid.innerHTML = '';
                
                const staffNameWidth = '80px';
                const dayColumnWidth = 'minmax(30px, 1fr)';
                
                grid.style.gridTemplateColumns = `${staffNameWidth} repeat(${this.daysInMonth}, ${dayColumnWidth})`;
                
                // è¡¨é ­
                grid.appendChild(this.createCell('', 'edit-header'));
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const dayName = this.getDayOfWeek(day);
                    const isWeekendDay = this.isWeekend(day);
                    const headerClass = `day-header ${isWeekendDay ? 'weekend' : ''}`;
                    
                    const cell = document.createElement('div');
                    cell.className = headerClass;
                    cell.innerHTML = `
                        <div class="day-number">${day}</div>
                        <div class="day-name">${dayName}</div>
                    `;
                    grid.appendChild(cell);
                }
                
                // å“¡å·¥è¡Œ
                this.staff.forEach(staff => {
                    // å“¡å·¥å§“å
                    const nameCell = this.createCell(staff.name, 'staff-name');
                    nameCell.contentEditable = true;
                    nameCell.addEventListener('blur', (e) => {
                        const newName = e.target.textContent.trim();
                        if (newName) {
                            staff.name = newName;
                            this.updateWorkloadTable();
                        }
                    });
                    grid.appendChild(nameCell);
                    
                    // æ¯æ—¥ç­åˆ¥é¸æ“‡
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        const cell = document.createElement('div');
                        cell.className = 'edit-cell';
                        
                        const schedule = this.schedule[staff.id][day];
                        
                        if (schedule.leave) {
                            cell.classList.add('leave');
                        } else if (schedule.shift) {
                            cell.classList.add(`shift-${schedule.shift}`);
                        }
                        
                        cell.innerHTML = `
                            <select onchange="scheduler.updateScheduleManual(${staff.id}, ${day}, this.value)" 
                                    onfocus="this.parentElement.style.zIndex='1000'" 
                                    onblur="this.parentElement.style.zIndex='auto'">
                                <option value="" ${schedule.shift === '' && !schedule.leave ? 'selected' : ''}>-</option>
                                <option value="O" ${schedule.shift === 'O' ? 'selected' : ''}>O</option>
                                <option value="N" ${schedule.shift === 'N' ? 'selected' : ''}>N</option>
                                <option value="R" ${schedule.shift === 'R' ? 'selected' : ''}>R</option>
                                <option value="C" ${schedule.shift === 'C' ? 'selected' : ''}>C</option>
                                <option value="S" ${schedule.shift === 'S' ? 'selected' : ''}>S</option>
                                <option value="leave" ${schedule.leave ? 'selected' : ''}>å‡</option>
                            </select>
                        `;
                        
                        grid.appendChild(cell);
                    }
                });
            }

            renderDailyStats() {
                const dailyStatsContainer = document.getElementById('dailyStatsTable');
                
                const dailyStats = [];
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const stats = {
                        O: 0, N: 0, R: 0, C: 0, S: 0
                    };
                    
                    this.staff.forEach(staff => {
                        const schedule = this.schedule[staff.id][day];
                        if (schedule.shift && !schedule.leave) {
                            stats[schedule.shift]++;
                        }
                    });
                    
                    dailyStats.push(stats);
                }

                const statsGrid = document.createElement('div');
                statsGrid.className = 'edit-grid';
                
                const staffNameWidth = '80px';
                const dayColumnWidth = 'minmax(30px, 1fr)';
                
                statsGrid.style.gridTemplateColumns = `${staffNameWidth} repeat(${this.daysInMonth}, ${dayColumnWidth})`;
                
                statsGrid.appendChild(this.createStatsCell('', 'edit-header'));
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const dayName = this.getDayOfWeek(day);
                    const isWeekendDay = this.isWeekend(day);
                    const headerClass = `day-header ${isWeekendDay ? 'weekend' : ''}`;
                    
                    const cell = document.createElement('div');
                    cell.className = headerClass;
                    cell.innerHTML = `
                        <div class="day-number">${day}</div>
                        <div class="day-name">${dayName}</div>
                    `;
                    statsGrid.appendChild(cell);
                }
                
                const shifts = [
                    { key: 'O', name: 'O', class: 'shift-O' },
                    { key: 'N', name: 'N', class: 'shift-N' },
                    { key: 'R', name: 'R', class: 'shift-R' },
                    { key: 'C', name: 'C', class: 'shift-C' },
                    { key: 'S', name: 'S', class: 'shift-S' }
                ];
                
                shifts.forEach(shift => {
                    statsGrid.appendChild(this.createStatsCell(shift.name, 'staff-name'));
                    
                    for (let day = 0; day < this.daysInMonth; day++) {
                        const count = dailyStats[day][shift.key];
                        const cell = this.createStatsCell(count.toString(), `edit-cell ${shift.class}`);
                        statsGrid.appendChild(cell);
                    }
                });

                dailyStatsContainer.innerHTML = '';
                dailyStatsContainer.appendChild(statsGrid);
            }

            updateWorkloadTable() {
                const tableBody = document.getElementById('workloadTableBody');
                
                const workloads = this.staff.map(staff => {
                    const workload = this.calculateWorkload(staff.id);
                    return {
                        name: staff.name,
                        ...workload
                    };
                });

                const avgHours = workloads.reduce((sum, w) => sum + w.totalHours, 0) / workloads.length;

                tableBody.innerHTML = workloads.map(w => {
                    const rowClass = w.totalHours > avgHours + 20 ? 'style="background-color: #ffebee;"' : 
                                   w.totalHours < avgHours - 20 ? 'style="background-color: #e8f5e8;"' : '';
                    
                    return `
                        <tr ${rowClass}>
                            <td><strong>${w.name}</strong></td>
                            <td>${w.O}</td>
                            <td>${w.N}</td>
                            <td>${w.R}</td>
                            <td>${w.C}</td>
                            <td>${w.S}</td>
                            <td>${w.totalShifts}</td>
                            <td><strong>${w.totalHours}å°æ™‚</strong></td>
                            <td>${w.avgDailyHours}å°æ™‚</td>
                        </tr>
                    `;
                }).join('');
            }

            renderStats() {
                const stats = document.getElementById('stats');
                
                if (!this.schedule || Object.keys(this.schedule).length === 0) {
                    stats.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-value">${this.staff.length}</div>
                            <div>ç¸½å“¡å·¥æ•¸</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div>ç¸½ç­æ¬¡æ•¸</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div>å¹³å‡ç­æ¬¡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div>å·¥æ™‚å·®ç•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div>å•é¡Œæ•¸é‡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div>é€£çºŒæ€§</div>
                        </div>
                    `;
                    return;
                }
                
                if (this.currentMode === 'auto') {
                    const workloadDetails = this.staff.map(staff => {
                        const workload = this.getWorkloadAuto(staff.id);
                        const dayShifts = this.getDayShiftCount(staff.id);
                        const nightShifts = this.getNightShiftCount(staff.id);
                        const totalShifts = dayShifts + nightShifts;
                        return {
                            name: staff.name,
                            workload: workload,
                            dayShifts: dayShifts,
                            nightShifts: nightShifts,
                            totalShifts: totalShifts
                        };
                    });
                    
                    const totalShifts = workloadDetails.reduce((sum, w) => sum + w.totalShifts, 0);
                    const avgShifts = totalShifts / this.staff.length;
                    const workloads = workloadDetails.map(w => w.workload);
                    const maxWorkload = Math.max(...workloads);
                    const minWorkload = Math.min(...workloads);
                    
                    const dayShiftFulfillment = this.calculateDayShiftFulfillment();
                    const nightShiftFulfillment = this.calculateNightShiftFulfillment();
                    const continuityScore = this.calculateContinuityScore();
                    
                    const workloadTable = workloadDetails
                        .sort((a, b) => b.totalShifts - a.totalShifts)
                        .map(w => `<div style="display: flex; justify-content: space-between; padding: 8px 12px; background: ${w.totalShifts > avgShifts + 2 ? '#ffebee' : w.totalShifts < avgShifts - 2 ? '#e8f5e8' : '#f8f9fa'}; margin: 3px 0; border-radius: 6px; border: 1px solid #dee2e6;">
                            <span style="font-weight: 500; color: #212529;">${w.name}</span>
                            <span style="font-weight: 600; color: #495057;">${w.totalShifts}ç­ (æ—¥:${w.dayShifts} å¤œ:${w.nightShifts})</span>
                        </div>`).join('');
                    
                    stats.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-value">${this.staff.length}</div>
                            <div>ç¸½å“¡å·¥æ•¸</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${totalShifts}</div>
                            <div>ç¸½ç­æ¬¡æ•¸</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${avgShifts.toFixed(1)}</div>
                            <div>å¹³å‡ç­æ¬¡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${((maxWorkload - minWorkload)/12).toFixed(1)}</div>
                            <div>ç­æ¬¡å·®ç•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${this.conflicts.length}</div>
                            <div>å•é¡Œæ•¸é‡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${continuityScore.toFixed(1)}%</div>
                            <div>é€£çºŒæ€§å¾—åˆ†</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${dayShiftFulfillment.toFixed(1)}%</div>
                            <div>ç™½ç­æ»¿è¶³ç‡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${nightShiftFulfillment.toFixed(1)}%</div>
                            <div>å¤œç­æ»¿è¶³ç‡</div>
                        </div>
                        <div class="stat-card" style="grid-column: 1/-1;">
                            <h4 style="margin-bottom: 10px;">å€‹äººå·¥ä½œè² è·åˆ†æ</h4>
                            ${workloadTable}
                            <div style="margin-top: 10px; padding: 8px; background: #e8f4f8; border-radius: 4px; font-size: 12px;">
                                ğŸ“Š é€£çºŒæ€§åˆ†æï¼š${continuityScore.toFixed(1)}% | 
                                ğŸ¯ ç›®æ¨™ï¼šæ¸›å°‘é›¶ç¢æ’ç­ï¼Œæé«˜å·¥ä½œæ•ˆç‡ | 
                                âœ¨ æœ€ä½³ç‹€æ…‹ï¼š80%ä»¥ä¸Šé€£çºŒæ€§å¾—åˆ†
                            </div>
                        </div>
                    `;
                } else {
                    // æ‰‹å‹•ç·¨è¼¯æ¨¡å¼çš„çµ±è¨ˆ
                    let totalShifts = 0;
                    let totalHours = 0;
                    const shiftCounts = { O: 0, N: 0, R: 0, C: 0, S: 0 };
                    const workloads = [];

                    this.staff.forEach(staff => {
                        const workload = this.calculateWorkload(staff.id);
                        workloads.push({
                            name: staff.name,
                            ...workload
                        });
                        
                        totalShifts += workload.totalShifts;
                        totalHours += workload.totalHours;
                        
                        Object.keys(shiftCounts).forEach(shift => {
                            shiftCounts[shift] += workload[shift];
                        });
                    });

                    const avgHoursPerPerson = (totalHours / this.staff.length).toFixed(1);
                    const avgShiftsPerPerson = (totalShifts / this.staff.length).toFixed(1);
                    
                    const hours = workloads.map(w => w.totalHours);
                    const maxHours = Math.max(...hours);
                    const minHours = Math.min(...hours);
                    const hoursDifference = maxHours - minHours;

                    stats.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-value">${this.staff.length}</div>
                            <div>ç¸½å“¡å·¥æ•¸</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${totalShifts}</div>
                            <div>ç¸½ç­æ¬¡æ•¸</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${totalHours}</div>
                            <div>ç¸½å·¥ä½œæ™‚æ•¸</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${avgHoursPerPerson}</div>
                            <div>å¹³å‡å·¥æ™‚/äºº</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${hoursDifference}</div>
                            <div>å·¥æ™‚å·®ç•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${shiftCounts.O}</div>
                            <div>ç™½ç­ç¸½æ•¸(O)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${shiftCounts.N}</div>
                            <div>å¤œç­ç¸½æ•¸(N)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${shiftCounts.R}</div>
                            <div>æ€¥æ•‘å®¤ç¸½æ•¸(R)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${shiftCounts.C}</div>
                            <div>çœ‹è¨ºç­ç¸½æ•¸(C)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${shiftCounts.S}</div>
                            <div>å¤–å‚·å°å¤œç¸½æ•¸(S)</div>
                        </div>
                    `;
                }
            }

            calculateNightShiftFulfillment() {
                let totalRequired = 0;
                let totalAssigned = 0;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const required = this.requirements[day].nightShift;
                    const assigned = this.staff.filter(staff => 
                        this.schedule[staff.id][day].nightShift).length;
                    
                    totalRequired += required;
                    totalAssigned += assigned;
                }
                
                return totalRequired > 0 ? (totalAssigned / totalRequired) * 100 : 100;
            }

            getDayShiftCount(staffId) {
                let count = 0;
                if (!this.schedule || !this.schedule[staffId]) return 0;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const schedule = this.schedule[staffId][day];
                    if (schedule && schedule.dayShift) count++;
                }
                return count;
            }

            getNightShiftCount(staffId) {
                let count = 0;
                if (!this.schedule || !this.schedule[staffId]) return 0;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const schedule = this.schedule[staffId][day];
                    if (schedule && schedule.nightShift) count++;
                }
                return count;
            }

            getWorkloadAuto(staffId) {
                let workload = 0;
                if (!this.schedule || !this.schedule[staffId]) return 0;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const schedule = this.schedule[staffId][day];
                    if (!schedule) continue;
                    
                    if (schedule.dayShift) workload += 12;
                    if (schedule.nightShift) workload += 12;
                }
                return workload;
            }

            // ========== å·¥å…·æ–¹æ³• ==========
            hasAutoScheduleData() {
                if (!this.schedule || Object.keys(this.schedule).length === 0) return false;
                
                // æª¢æŸ¥æ˜¯å¦æœ‰è‡ªå‹•æ’ç­çš„è³‡æ–™çµæ§‹ï¼ˆdayShift/nightShiftï¼‰
                for (let staffId in this.schedule) {
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        const schedule = this.schedule[staffId][day];
                        if (schedule && (schedule.hasOwnProperty('dayShift') || schedule.hasOwnProperty('nightShift'))) {
                            if (schedule.dayShift || schedule.nightShift) {
                                return true;
                            }
                        }
                    }
                }
                return false;
            }

            hasManualScheduleData() {
                if (!this.schedule || Object.keys(this.schedule).length === 0) return false;
                
                // æª¢æŸ¥æ˜¯å¦æœ‰æ‰‹å‹•ç·¨è¼¯çš„è³‡æ–™çµæ§‹ï¼ˆshiftå±¬æ€§ï¼‰
                for (let staffId in this.schedule) {
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        const schedule = this.schedule[staffId][day];
                        if (schedule && schedule.hasOwnProperty('shift')) {
                            if (schedule.shift && schedule.shift !== '') {
                                return true;
                            }
                        }
                    }
                }
                return false;
            }

            createCell(content, className) {
                const cell = document.createElement('div');
                cell.className = className;
                cell.textContent = content;
                return cell;
            }

            createStatsCell(content, className) {
                const cell = document.createElement('div');
                cell.className = className;
                cell.textContent = content;
                return cell;
            }

            updateStaffName(staffId, newName) {
                if (newName && newName.trim()) {
                    this.staff[staffId].name = newName.trim();
                    
                    if (this.schedule && Object.keys(this.schedule).length > 0) {
                        this.renderSchedule();
                        this.renderStats();
                    }
                }
            }

            updateLeave(staffId, leaveStr) {
                const leaves = leaveStr.split(',')
                    .map(s => parseInt(s.trim()))
                    .filter(n => !isNaN(n) && n >= 1 && n <= this.daysInMonth);
                
                this.staff[staffId].leaveRequests = leaves;
                this.renderStaffGrid();
                this.renderLeaveAnalysis();
                this.renderRequirementsGrid();
                
                // ä¸è¦é‡æ–°åˆå§‹åŒ–æ’ç­è³‡æ–™ï¼Œåªæ›´æ–°è«‹å‡ç‹€æ…‹
                if (this.schedule && Object.keys(this.schedule).length > 0) {
                    // æ›´æ–°ç¾æœ‰æ’ç­ä¸­çš„è«‹å‡ç‹€æ…‹
                    if (this.currentMode === 'auto') {
                        for (let day = 1; day <= this.daysInMonth; day++) {
                            if (this.schedule[staffId] && this.schedule[staffId][day]) {
                                this.schedule[staffId][day].leave = leaves.includes(day);
                            }
                        }
                    } else {
                        for (let day = 1; day <= this.daysInMonth; day++) {
                            if (this.schedule[staffId] && this.schedule[staffId][day]) {
                                this.schedule[staffId][day].leave = leaves.includes(day);
                                // å¦‚æœè¨­å®šç‚ºè«‹å‡ï¼Œæ¸…é™¤ç­åˆ¥
                                if (leaves.includes(day)) {
                                    this.schedule[staffId][day].shift = '';
                                }
                            }
                        }
                    }
                    this.renderSchedule();
                }
            }

            updateRequirement(day, shift, value) {
                this.requirements[day][shift] = parseInt(value);
                this.renderRequirementsSummary();
            }

            showAlert(message, type) {
                const container = document.getElementById('alertContainer');
                if (!container) return;
                
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.innerHTML = message.replace(/\n/g, '<br>');
                
                container.innerHTML = '';
                container.appendChild(alert);
                
                setTimeout(() => {
                    if (container.contains(alert)) {
                        container.removeChild(alert);
                    }
                }, 5000);
            }

            exportSchedule() {
                if (this.currentMode === 'auto') {
                    this.exportAutoSchedule();
                } else {
                    this.exportManualSchedule();
                }
            }

            exportAutoSchedule() {
                let csv = 'å“¡å·¥å§“å';
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const dayName = this.getDayOfWeek(day);
                    csv += `,${day}(${dayName})`;
                }
                csv += ',ç¸½å·¥æ™‚,ç™½ç­æ¬¡æ•¸,å¤œç­æ¬¡æ•¸,é€£çºŒå·¥ä½œå¡Šæ•¸\n';
                
                this.staff.forEach(staff => {
                    csv += staff.name;
                    let totalHours = 0;
                    let dayCount = 0;
                    let nightCount = 0;
                    
                    const workDays = [];
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        const schedule = this.schedule[staff.id][day];
                        if (schedule.dayShift || schedule.nightShift) {
                            workDays.push(day);
                        }
                    }
                    
                    let continuousBlocks = 0;
                    if (workDays.length > 0) {
                        continuousBlocks = 1;
                        for (let i = 1; i < workDays.length; i++) {
                            if (workDays[i] !== workDays[i-1] + 1) {
                                continuousBlocks++;
                            }
                        }
                    }
                    
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        const schedule = this.schedule[staff.id][day];
                        let cellValue = '';
                        
                        if (schedule.leave) {
                            cellValue = 'è«‹å‡';
                        } else if (schedule.dayShift && schedule.nightShift) {
                            cellValue = 'O+N';
                            totalHours += 24;
                            dayCount++;
                            nightCount++;
                        } else if (schedule.dayShift) {
                            cellValue = 'O';
                            totalHours += 12;
                            dayCount++;
                        } else if (schedule.nightShift) {
                            cellValue = 'N';
                            totalHours += 12;
                            nightCount++;
                        }
                        
                        csv += `,${cellValue}`;
                    }
                    
                    csv += `,${totalHours}å°æ™‚,${dayCount},${nightCount},${continuousBlocks}å¡Š\n`;
                });
                
                const continuityScore = this.calculateContinuityScore();
                csv += `\næ‘˜è¦è³‡è¨Š,,,,,,,\n`;
                csv += `é€£çºŒæ€§å¾—åˆ†,${continuityScore.toFixed(1)}%,,,,,,\n`;
                csv += `å„ªåŒ–é¸é …,${document.getElementById('enableContinuity').checked ? 'é€£çºŒæ€§âœ“' : 'é€£çºŒæ€§âœ—'},${document.getElementById('balanceWorkload').checked ? 'å¹³è¡¡âœ“' : 'å¹³è¡¡âœ—'},${document.getElementById('avoidFragmentation').checked ? 'é¿å…é›¶ç¢âœ“' : 'é¿å…é›¶ç¢âœ—'},,,,\n`;
                
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `æ€¥è¨ºæ’ç­è¡¨_è‡ªå‹•ç‰ˆ_${this.currentMonth}.csv`;
                link.click();
            }

            exportManualSchedule() {
                let csv = 'å“¡å·¥å§“å';
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const dayName = this.getDayOfWeek(day);
                    csv += `,${day}(${dayName})`;
                }
                csv += `,ç™½ç­(O),å¤œç­(N),æ€¥æ•‘å®¤(R),çœ‹è¨ºç­(C),å¤–å‚·å°å¤œ(S),ç¸½ç­æ¬¡,ç¸½å·¥æ™‚,å¹³å‡æ—¥å·¥æ™‚\n`;
                
                this.staff.forEach(staff => {
                    const workload = this.calculateWorkload(staff.id);
                    csv += staff.name;
                    
                    for (let day = 1; day <= this.daysInMonth; day++) {
                        const schedule = this.schedule[staff.id][day];
                        let cellValue = '';
                        
                        if (schedule.leave) {
                            cellValue = 'è«‹å‡';
                        } else if (schedule.shift) {
                            cellValue = schedule.shift;
                        }
                        
                        csv += `,${cellValue}`;
                    }
                    
                    csv += `,${workload.O},${workload.N},${workload.R},${workload.C},${workload.S},${workload.totalShifts},${workload.totalHours}å°æ™‚,${workload.avgDailyHours}å°æ™‚\n`;
                });
                
                const totalHours = this.staff.reduce((sum, staff) => {
                    return sum + this.calculateWorkload(staff.id).totalHours;
                }, 0);
                const avgHours = (totalHours / this.staff.length).toFixed(1);
                
                csv += `\næ‘˜è¦è³‡è¨Š,,,,,,,,,\n`;
                csv += `ç¸½å·¥æ™‚,${totalHours}å°æ™‚,,,,,,,,\n`;
                csv += `å¹³å‡å·¥æ™‚,${avgHours}å°æ™‚/äºº,,,,,,,,\n`;
                csv += `ç­åˆ¥å·¥æ™‚è¨­å®š,O:${this.shiftHours.O}h N:${this.shiftHours.N}h R:${this.shiftHours.R}h C:${this.shiftHours.C}h S:${this.shiftHours.S}h,,,,,,,,\n`;
                
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `æ€¥è¨ºæ’ç­è¡¨_ç·¨è¼¯ç‰ˆ_${this.currentMonth}.csv`;
                link.click();
                
                this.showAlert('æ’ç­è¡¨å·²åŒ¯å‡º', 'success');
            }

            renderAll() {
                if (this.currentMode === 'auto') {
                    this.renderStaffGrid();
                    this.renderRequirements();
                    this.renderSchedule();
                    this.renderStats();
                    this.renderConflicts();
                } else {
                    this.renderEditMode();
                }
            }

            renderEditMode() {
                this.renderEditGrid();
                this.renderDailyStats();
                this.updateWorkloadTable();
                this.renderSchedule();
                this.renderStats();
            }
        }

        // ========== å…¨åŸŸå‡½æ•¸ ==========
        const scheduler = new IntegratedScheduler();

        function generateStaffList() {
            // ä¿å­˜ç¾æœ‰çš„æ’ç­è³‡æ–™
            const existingSchedule = scheduler.schedule ? JSON.parse(JSON.stringify(scheduler.schedule)) : null;
            const currentMode = scheduler.currentMode;
            
            scheduler.generateStaffList();
            
            // æ¢å¾©æ’ç­è³‡æ–™
            if (existingSchedule) {
                scheduler.schedule = existingSchedule;
                console.log('æ¢å¾©äº†æ’ç­è³‡æ–™');
            }
            
            // æ ¹æ“šç•¶å‰æ¨¡å¼é‡æ–°æ¸²æŸ“
            if (currentMode === 'auto') {
                scheduler.renderAll();
            } else {
                scheduler.renderEditMode();
            }
        }

        function generateSchedule() {
            scheduler.currentMode = 'auto';
            scheduler.initializeEmptySchedule();
            scheduler.generateSchedule();
        }

        function exportSchedule() {
            scheduler.exportSchedule();
        }

        function convertToEditMode() {
            scheduler.convertToEditMode();
        }

        function clearAllShifts() {
            scheduler.clearAllShifts();
        }

        function checkConflicts() {
            scheduler.checkConflicts();
        }

        // åˆ†é åˆ‡æ›åŠŸèƒ½
        function switchTab(tabName) {
            console.log(`åˆ‡æ›åˆ° ${tabName} åˆ†é ï¼Œç•¶å‰æ’ç­è³‡æ–™:`, scheduler.schedule ? Object.keys(scheduler.schedule).length : 0);
            
            // éš±è—æ‰€æœ‰åˆ†é å…§å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰åˆ†é æŒ‰éˆ•çš„activeé¡
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„åˆ†é å…§å®¹
            if (tabName === 'auto') {
                document.getElementById('autoTab').classList.add('active');
                document.querySelector('.tab-button:first-child').classList.add('active');
                
                // åˆ‡æ›åˆ°è‡ªå‹•æ’ç­æ¨¡å¼ï¼Œä¿ç•™æ‰€æœ‰ç¾æœ‰è³‡æ–™
                scheduler.currentMode = 'auto';
                console.log('åˆ‡æ›åˆ°è‡ªå‹•æ’ç­æ¨¡å¼ï¼Œä¿ç•™è³‡æ–™');
                scheduler.renderAll();
            } else if (tabName === 'manual') {
                document.getElementById('manualTab').classList.add('active');
                document.querySelector('.tab-button:last-child').classList.add('active');
                
                // åˆ‡æ›åˆ°æ‰‹å‹•ç·¨è¼¯æ¨¡å¼
                scheduler.currentMode = 'manual';
                console.log('åˆ‡æ›åˆ°æ‰‹å‹•ç·¨è¼¯æ¨¡å¼');
                
                // å¦‚æœæ²’æœ‰ä»»ä½•æ’ç­è³‡æ–™ï¼Œåˆå§‹åŒ–ç©ºçš„æ‰‹å‹•ç·¨è¼¯æ ¼å¼
                if (!scheduler.schedule || Object.keys(scheduler.schedule).length === 0) {
                    console.log('æ²’æœ‰æ’ç­è³‡æ–™ï¼Œåˆå§‹åŒ–ç©ºçš„æ‰‹å‹•ç·¨è¼¯æ ¼å¼');
                    scheduler.initializeEmptySchedule();
                }
                
                scheduler.renderEditMode();
            }
            
            console.log(`åˆ†é åˆ‡æ›å®Œæˆï¼Œç•¶å‰æ’ç­è³‡æ–™:`, scheduler.schedule ? Object.keys(scheduler.schedule).length : 0);
        }

        // æ‘ºç–ŠåŠŸèƒ½
        function toggleSection(sectionName) {
            const content = document.getElementById(sectionName + '-content');
            const icon = document.getElementById(sectionName + '-icon');
            
            if (content && icon) {
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    icon.classList.remove('collapsed');
                    icon.textContent = 'â–¼';
                } else {
                    content.classList.add('collapsed');
                    icon.classList.add('collapsed');
                    icon.textContent = 'â–¶';
                }
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            scheduler.init();
        });

        // æœˆä»½è®Šæ›´æ™‚æ›´æ–°
        document.getElementById('monthSelect').addEventListener('change', () => {
            scheduler.init();
        });
    </script>
</body>
</html>
                